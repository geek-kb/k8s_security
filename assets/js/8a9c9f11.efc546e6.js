"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[3273],{6821(e,n,s){s.r(n),s.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});const r=JSON.parse('{"id":"best_practices/cluster_setup_and_hardening/rbac_and_identity/debug_container_security","title":"Securing Debug Container Access","description":"How to control ephemeral container and kubectl debug access through RBAC, Pod Security Standards, and admission control in Kubernetes.","source":"@site/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/debug_container_security.md","sourceDirName":"best_practices/cluster_setup_and_hardening/rbac_and_identity","slug":"/best_practices/cluster_setup_and_hardening/rbac_and_identity/debug_container_security","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/debug_container_security","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/debug_container_security.md","tags":[{"inline":true,"label":"best-practice","permalink":"/docs/tags/best-practice"},{"inline":true,"label":"mitigation","permalink":"/docs/tags/mitigation"},{"inline":true,"label":"rbac","permalink":"/docs/tags/rbac"},{"inline":true,"label":"pod-security","permalink":"/docs/tags/pod-security"},{"inline":true,"label":"CKS","permalink":"/docs/tags/cks"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1770658335000,"sidebarPosition":13,"frontMatter":{"sidebar_position":13,"title":"Securing Debug Container Access","description":"How to control ephemeral container and kubectl debug access through RBAC, Pod Security Standards, and admission control in Kubernetes.","keywords":["kubernetes security best practices","ephemeral containers","kubectl debug","debug container RBAC","pod security","process namespace","debugging security","admission control","CKS"],"tags":["best-practice","mitigation","rbac","pod-security","CKS"],"related":["/docs/attack_vectors/ephemeral_container_abuse/","/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/insecure_rbac_permissions_mitigation/","/docs/best_practices/cluster_setup_and_hardening/pod_security/pod_security_standards/"]},"sidebar":"default","previous":{"title":"Securing Exec and Attach Access","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/exec_attach_security"},"next":{"title":"Insecure Secrets Management Mitigation","permalink":"/docs/best_practices/cluster_setup_and_hardening/secrets_management/insecure_secrets_management_mitigation"}}');var i=s(4848),t=s(8453);const a={sidebar_position:13,title:"Securing Debug Container Access",description:"How to control ephemeral container and kubectl debug access through RBAC, Pod Security Standards, and admission control in Kubernetes.",keywords:["kubernetes security best practices","ephemeral containers","kubectl debug","debug container RBAC","pod security","process namespace","debugging security","admission control","CKS"],tags:["best-practice","mitigation","rbac","pod-security","CKS"],related:["/docs/attack_vectors/ephemeral_container_abuse/","/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/insecure_rbac_permissions_mitigation/","/docs/best_practices/cluster_setup_and_hardening/pod_security/pod_security_standards/"]},c="Securing Debug Container Access",o={},d=[{value:"1. Restrict Ephemeral Container RBAC Permissions",id:"1-restrict-ephemeral-container-rbac-permissions",level:2},{value:"Identify Current Permissions",id:"identify-current-permissions",level:3},{value:"Create Restrictive Role Without Debug Access",id:"create-restrictive-role-without-debug-access",level:3},{value:"Deny Debug for Service Accounts",id:"deny-debug-for-service-accounts",level:3},{value:"2. Restrict Node Debugging",id:"2-restrict-node-debugging",level:2},{value:"Deny Node Debug Access",id:"deny-node-debug-access",level:3},{value:"Audit Node Proxy Access",id:"audit-node-proxy-access",level:3},{value:"3. Use Admission Control to Block Debug Containers",id:"3-use-admission-control-to-block-debug-containers",level:2},{value:"Kyverno Policy to Block Ephemeral Containers",id:"kyverno-policy-to-block-ephemeral-containers",level:3},{value:"OPA Gatekeeper Constraint",id:"opa-gatekeeper-constraint",level:3},{value:"4. Restrict Debug Container Capabilities",id:"4-restrict-debug-container-capabilities",level:2},{value:"Enforce Restricted Profile",id:"enforce-restricted-profile",level:3},{value:"Kyverno Policy for Debug Container Security Context",id:"kyverno-policy-for-debug-container-security-context",level:3},{value:"5. Audit and Monitor Debug Container Usage",id:"5-audit-and-monitor-debug-container-usage",level:2},{value:"API Server Audit Policy",id:"api-server-audit-policy",level:3},{value:"Falco Rules",id:"falco-rules",level:3},{value:"Prometheus Alert",id:"prometheus-alert",level:3},{value:"Security Checklist",id:"security-checklist",level:2},{value:"References",id:"references",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,t.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"securing-debug-container-access",children:"Securing Debug Container Access"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Required knowledge for the CKS certification."})}),"\n",(0,i.jsxs)(n.p,{children:["Ephemeral containers and ",(0,i.jsx)(n.code,{children:"kubectl debug"})," provide powerful debugging capabilities that can be abused if not properly controlled. Attackers with permissions to create ephemeral containers can inject debugging tools into running pods, access shared process namespaces, and extract sensitive data."]}),"\n",(0,i.jsx)(n.p,{children:"This guide covers how to restrict debug container access through RBAC, admission control, and monitoring."}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"1-restrict-ephemeral-container-rbac-permissions",children:"1. Restrict Ephemeral Container RBAC Permissions"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," Users with broad pod permissions may implicitly have access to create ephemeral containers.",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.strong,{children:"Fix:"})," Explicitly deny ",(0,i.jsx)(n.code,{children:"pods/ephemeralcontainers"})," access in RBAC roles."]}),"\n",(0,i.jsx)(n.h3,{id:"identify-current-permissions",children:"Identify Current Permissions"}),"\n",(0,i.jsx)(n.p,{children:"Check who can create ephemeral containers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"kubectl auth can-i create pods/ephemeralcontainers --all-namespaces --list\n"})}),"\n",(0,i.jsx)(n.h3,{id:"create-restrictive-role-without-debug-access",children:"Create Restrictive Role Without Debug Access"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: developer-no-debug\n  namespace: production\nrules:\n  - apiGroups: [""]\n    resources: ["pods"]\n    verbs: ["get", "list", "watch"]\n  - apiGroups: [""]\n    resources: ["pods/log"]\n    verbs: ["get"]\n  # Explicitly omit pods/ephemeralcontainers\n  # Explicitly omit pods/exec\n'})}),"\n",(0,i.jsx)(n.h3,{id:"deny-debug-for-service-accounts",children:"Deny Debug for Service Accounts"}),"\n",(0,i.jsx)(n.p,{children:"Ensure service accounts cannot create debug containers:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: no-debug-access\nrules:\n  - apiGroups: [""]\n    resources: ["pods/ephemeralcontainers"]\n    verbs: []\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: deny-debug-all-serviceaccounts\nsubjects:\n  - kind: Group\n    name: system:serviceaccounts\n    apiGroup: rbac.authorization.k8s.io\nroleRef:\n  kind: ClusterRole\n  name: no-debug-access\n  apiGroup: rbac.authorization.k8s.io\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"2-restrict-node-debugging",children:"2. Restrict Node Debugging"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," ",(0,i.jsx)(n.code,{children:"kubectl debug node/"})," provides host-level access to nodes.",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.strong,{children:"Fix:"})," Restrict ",(0,i.jsx)(n.code,{children:"nodes/proxy"})," permissions."]}),"\n",(0,i.jsx)(n.h3,{id:"deny-node-debug-access",children:"Deny Node Debug Access"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: developer-restricted\nrules:\n  - apiGroups: [""]\n    resources: ["nodes"]\n    verbs: ["get", "list"]\n  # Do NOT include nodes/proxy - this enables node debugging\n'})}),"\n",(0,i.jsx)(n.h3,{id:"audit-node-proxy-access",children:"Audit Node Proxy Access"}),"\n",(0,i.jsx)(n.p,{children:"Identify who has node proxy access:"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'kubectl get clusterrolebindings -o json | \\\n  jq -r \'.items[] | select(.roleRef.name == "cluster-admin" or \n    (.roleRef.name | test("node"))) | .metadata.name\'\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"3-use-admission-control-to-block-debug-containers",children:"3. Use Admission Control to Block Debug Containers"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," RBAC alone may not prevent all debug container scenarios.",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.strong,{children:"Fix:"})," Use admission controllers to enforce additional restrictions."]}),"\n",(0,i.jsx)(n.h3,{id:"kyverno-policy-to-block-ephemeral-containers",children:"Kyverno Policy to Block Ephemeral Containers"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: block-ephemeral-containers\nspec:\n  validationFailureAction: Enforce\n  background: false\n  rules:\n    - name: block-ephemeral-containers-production\n      match:\n        any:\n          - resources:\n              kinds:\n                - Pod\n              namespaces:\n                - production\n                - finance\n      validate:\n        message: "Ephemeral containers are not allowed in this namespace"\n        deny:\n          conditions:\n            any:\n              - key: "{{ request.operation }}"\n                operator: Equals\n                value: "UPDATE"\n              - key: "{{ length(request.object.spec.ephemeralContainers || `[]`) }}"\n                operator: GreaterThan\n                value: 0\n'})}),"\n",(0,i.jsx)(n.h3,{id:"opa-gatekeeper-constraint",children:"OPA Gatekeeper Constraint"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1\nkind: ConstraintTemplate\nmetadata:\n  name: blockephemeralcontainers\nspec:\n  crd:\n    spec:\n      names:\n        kind: BlockEphemeralContainers\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package blockephemeralcontainers\n        \n        violation[{"msg": msg}] {\n          input.review.operation == "UPDATE"\n          container := input.review.object.spec.ephemeralContainers[_]\n          msg := sprintf("Ephemeral container %v not allowed", [container.name])\n        }\n---\napiVersion: constraints.gatekeeper.sh/v1beta1\nkind: BlockEphemeralContainers\nmetadata:\n  name: block-ephemeral-production\nspec:\n  match:\n    namespaces: ["production"]\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"4-restrict-debug-container-capabilities",children:"4. Restrict Debug Container Capabilities"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," Debug containers may run with elevated privileges.",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.strong,{children:"Fix:"})," Apply Pod Security Standards to ephemeral containers."]}),"\n",(0,i.jsx)(n.h3,{id:"enforce-restricted-profile",children:"Enforce Restricted Profile"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: production\n  labels:\n    pod-security.kubernetes.io/enforce: restricted\n    pod-security.kubernetes.io/enforce-version: latest\n"})}),"\n",(0,i.jsx)(n.p,{children:"The restricted profile blocks:"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Privileged containers"}),"\n",(0,i.jsx)(n.li,{children:"Host namespace access"}),"\n",(0,i.jsx)(n.li,{children:"Privilege escalation"}),"\n",(0,i.jsx)(n.li,{children:"Root user execution"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"kyverno-policy-for-debug-container-security-context",children:"Kyverno Policy for Debug Container Security Context"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: kyverno.io/v1\nkind: ClusterPolicy\nmetadata:\n  name: restrict-ephemeral-container-privileges\nspec:\n  validationFailureAction: Enforce\n  rules:\n    - name: restrict-ephemeral-security-context\n      match:\n        any:\n          - resources:\n              kinds:\n                - Pod\n      validate:\n        message: "Ephemeral containers must not run as privileged"\n        pattern:\n          spec:\n            ephemeralContainers:\n              - securityContext:\n                  privileged: false\n                  allowPrivilegeEscalation: false\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"5-audit-and-monitor-debug-container-usage",children:"5. Audit and Monitor Debug Container Usage"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Issue:"})," Debug container usage may indicate reconnaissance or unauthorized access.",(0,i.jsx)("br",{}),"\n",(0,i.jsx)(n.strong,{children:"Fix:"})," Enable audit logging and alerting for ephemeral container creation."]}),"\n",(0,i.jsx)(n.h3,{id:"api-server-audit-policy",children:"API Server Audit Policy"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'apiVersion: audit.k8s.io/v1\nkind: Policy\nrules:\n  - level: RequestResponse\n    verbs: ["patch", "update"]\n    resources:\n      - group: ""\n        resources: ["pods/ephemeralcontainers"]\n    omitStages:\n      - RequestReceived\n  - level: RequestResponse\n    verbs: ["create"]\n    resources:\n      - group: ""\n        resources: ["nodes/proxy"]\n    omitStages:\n      - RequestReceived\n'})}),"\n",(0,i.jsx)(n.h3,{id:"falco-rules",children:"Falco Rules"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:"- rule: Ephemeral Container Created\n  desc: Detect creation of ephemeral debug containers\n  condition: >\n    kevt and \n    ka.verb in (patch, update) and\n    ka.target.resource = pods and\n    ka.target.subresource = ephemeralcontainers\n  output: >\n    Ephemeral container created (user=%ka.user.name \n    pod=%ka.target.name ns=%ka.target.namespace)\n  priority: WARNING\n  tags: [k8s, debug, security]\n\n- rule: Node Debug Session Started\n  desc: Detect kubectl debug node commands\n  condition: >\n    kevt and \n    ka.verb = create and\n    ka.target.resource = nodes and\n    ka.target.subresource = proxy\n  output: >\n    Node debug session started (user=%ka.user.name node=%ka.target.name)\n  priority: CRITICAL\n  tags: [k8s, node, debug]\n"})}),"\n",(0,i.jsx)(n.h3,{id:"prometheus-alert",children:"Prometheus Alert"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-yaml",children:'- alert: EphemeralContainerCreated\n  expr: |\n    increase(apiserver_audit_event_total{\n      verb=~"patch|update",\n      objectRef_resource="pods",\n      objectRef_subresource="ephemeralcontainers"\n    }[5m]) > 0\n  labels:\n    severity: warning\n  annotations:\n    summary: "Ephemeral container created in cluster"\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"security-checklist",children:"Security Checklist"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.code,{children:"pods/ephemeralcontainers"})," permissions explicitly denied for non-admin users"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.code,{children:"nodes/proxy"})," permissions restricted to cluster administrators"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Admission policies block ephemeral containers in sensitive namespaces"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Pod Security Standards enforced (restricted profile)"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Audit logging enabled for ephemeral container operations"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Alerting configured for debug container creation"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Regular review of RBAC bindings for debug permissions"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,i.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/workloads/pods/ephemeral-containers/",children:"Ephemeral Containers"})," - Kubernetes Documentation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/tasks/debug/debug-application/debug-running-pod/",children:"Debugging Running Pods"})," - Kubernetes Documentation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/rbac/",children:"Using RBAC Authorization"})," - Kubernetes Documentation"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/security/pod-security-standards/",children:"Pod Security Standards"})," - Kubernetes Documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,t.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(l,{...e})}):l(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>c});var r=s(6540);const i={},t=r.createContext(i);function a(e){const n=r.useContext(t);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:a(e.components),r.createElement(t.Provider,{value:n},e.children)}}}]);