"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[9142],{1808(e,n,i){i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>u,frontMatter:()=>r,metadata:()=>t,toc:()=>o});const t=JSON.parse('{"id":"best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity","title":"aad-pod-identity","description":"aad-pod-identity enables Kubernetes pods on Azure to use Azure Active Directory identities for accessing Azure resources without storing credentials.","source":"@site/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity.md","sourceDirName":"best_practices/cluster_setup_and_hardening/rbac_and_identity","slug":"/best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity.md","tags":[{"inline":true,"label":"tool","permalink":"/docs/tags/tool"},{"inline":true,"label":"rbac","permalink":"/docs/tags/rbac"},{"inline":true,"label":"cloud-security","permalink":"/docs/tags/cloud-security"},{"inline":true,"label":"Azure","permalink":"/docs/tags/azure"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771232119000,"sidebarPosition":22,"frontMatter":{"sidebar_position":22,"title":"aad-pod-identity","description":"aad-pod-identity enables Kubernetes pods on Azure to use Azure Active Directory identities for accessing Azure resources without storing credentials.","keywords":["kubernetes security tool","aad-pod-identity","Azure AD","pod identity","kubernetes Azure integration","managed identity","credential management","cloud security","AKS"],"tags":["tool","rbac","cloud-security","Azure"],"related":["/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kube2iam/","/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/attack_vectors/cloud_metadata_service_abuse/"]},"sidebar":"default","previous":{"title":"kiam","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam"},"next":{"title":"Insecure Secrets Management Mitigation","permalink":"/docs/best_practices/cluster_setup_and_hardening/secrets_management/insecure_secrets_management_mitigation"}}');var s=i(4848),a=i(8453);const r={sidebar_position:22,title:"aad-pod-identity",description:"aad-pod-identity enables Kubernetes pods on Azure to use Azure Active Directory identities for accessing Azure resources without storing credentials.",keywords:["kubernetes security tool","aad-pod-identity","Azure AD","pod identity","kubernetes Azure integration","managed identity","credential management","cloud security","AKS"],tags:["tool","rbac","cloud-security","Azure"],related:["/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kube2iam/","/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/attack_vectors/cloud_metadata_service_abuse/"]},d="aad-pod-identity",c={},o=[{value:"How It Works",id:"how-it-works",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installation",id:"installation",level:2},{value:"Using Helm",id:"using-helm",level:3},{value:"Using kubectl",id:"using-kubectl",level:3},{value:"Create Azure Resources",id:"create-azure-resources",level:2},{value:"Create User-Assigned Managed Identity",id:"create-user-assigned-managed-identity",level:3},{value:"Grant Azure RBAC Permissions",id:"grant-azure-rbac-permissions",level:3},{value:"Configure Kubernetes Resources",id:"configure-kubernetes-resources",level:2},{value:"Create AzureIdentity",id:"create-azureidentity",level:3},{value:"Create AzureIdentityBinding",id:"create-azureidentitybinding",level:3},{value:"Deploy Pod with Identity",id:"deploy-pod-with-identity",level:3},{value:"Usage in Applications",id:"usage-in-applications",level:2},{value:"Python Example",id:"python-example",level:3},{value:".NET Example",id:"net-example",level:3},{value:"Security Best Practices",id:"security-best-practices",level:2},{value:"Restrict Identity Assignment",id:"restrict-identity-assignment",level:3},{value:"Use Exception Lists",id:"use-exception-lists",level:3},{value:"Monitor Identity Usage",id:"monitor-identity-usage",level:3},{value:"Migration to Workload Identity",id:"migration-to-workload-identity",level:2},{value:"Troubleshooting",id:"troubleshooting",level:2},{value:"Check MIC Logs",id:"check-mic-logs",level:3},{value:"Check NMI Logs",id:"check-nmi-logs",level:3},{value:"Verify Identity Assignment",id:"verify-identity-assignment",level:3},{value:"References",id:"references",level:2}];function l(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"aad-pod-identity",children:"aad-pod-identity"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"aad-pod-identity"})," enables Kubernetes pods to use Azure Active Directory (Azure AD) managed identities for accessing Azure resources. Pods can authenticate to Azure services like Key Vault, Storage, and databases without storing credentials in secrets or configuration files."]}),"\n",(0,s.jsx)(n.p,{children:"This component is particularly useful for Azure Kubernetes Service (AKS) clusters but can also be deployed on self-managed Kubernetes clusters in Azure."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"An AzureIdentity custom resource defines a managed identity."}),"\n",(0,s.jsx)(n.li,{children:"An AzureIdentityBinding links the identity to pods with matching labels."}),"\n",(0,s.jsx)(n.li,{children:"The Node Managed Identity (NMI) pods intercept Azure Instance Metadata Service (IMDS) requests."}),"\n",(0,s.jsx)(n.li,{children:"The Managed Identity Controller (MIC) assigns identities to nodes as needed."}),"\n",(0,s.jsx)(n.li,{children:"Pods receive Azure AD tokens for their assigned identity."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Azure Kubernetes Service (AKS) or Kubernetes cluster running in Azure."}),"\n",(0,s.jsx)(n.li,{children:"User-assigned managed identities created in Azure."}),"\n",(0,s.jsx)(n.li,{children:"Azure RBAC permissions configured for managed identities."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.h3,{id:"using-helm",children:"Using Helm"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"helm repo add aad-pod-identity https://raw.githubusercontent.com/Azure/aad-pod-identity/master/charts\nhelm install aad-pod-identity aad-pod-identity/aad-pod-identity --namespace kube-system\n"})}),"\n",(0,s.jsx)(n.h3,{id:"using-kubectl",children:"Using kubectl"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://raw.githubusercontent.com/Azure/aad-pod-identity/master/deploy/infra/deployment-rbac.yaml\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"create-azure-resources",children:"Create Azure Resources"}),"\n",(0,s.jsx)(n.h3,{id:"create-user-assigned-managed-identity",children:"Create User-Assigned Managed Identity"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Create managed identity\naz identity create \\\n  --name my-app-identity \\\n  --resource-group my-resource-group \\\n  --location eastus\n\n# Get identity client ID and resource ID\nCLIENT_ID=$(az identity show --name my-app-identity --resource-group my-resource-group --query clientId -o tsv)\nRESOURCE_ID=$(az identity show --name my-app-identity --resource-group my-resource-group --query id -o tsv)\n"})}),"\n",(0,s.jsx)(n.h3,{id:"grant-azure-rbac-permissions",children:"Grant Azure RBAC Permissions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Grant access to Key Vault\naz keyvault set-policy \\\n  --name my-key-vault \\\n  --object-id $CLIENT_ID \\\n  --secret-permissions get list\n\n# Grant access to Storage Account\naz role assignment create \\\n  --role "Storage Blob Data Reader" \\\n  --assignee $CLIENT_ID \\\n  --scope /subscriptions/<subscription-id>/resourceGroups/my-resource-group/providers/Microsoft.Storage/storageAccounts/mystorageaccount\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"configure-kubernetes-resources",children:"Configure Kubernetes Resources"}),"\n",(0,s.jsx)(n.h3,{id:"create-azureidentity",children:"Create AzureIdentity"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: aadpodidentity.k8s.io/v1\nkind: AzureIdentity\nmetadata:\n  name: my-app-identity\n  namespace: default\nspec:\n  type: 0\n  resourceID: /subscriptions/<subscription-id>/resourcegroups/my-resource-group/providers/Microsoft.ManagedIdentity/userAssignedIdentities/my-app-identity\n  clientID: <client-id-of-managed-identity>\n"})}),"\n",(0,s.jsx)(n.h3,{id:"create-azureidentitybinding",children:"Create AzureIdentityBinding"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: aadpodidentity.k8s.io/v1\nkind: AzureIdentityBinding\nmetadata:\n  name: my-app-identity-binding\n  namespace: default\nspec:\n  azureIdentity: my-app-identity\n  selector: my-app\n"})}),"\n",(0,s.jsx)(n.h3,{id:"deploy-pod-with-identity",children:"Deploy Pod with Identity"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: my-app\n  labels:\n    aadpodidbinding: my-app\nspec:\n  containers:\n    - name: my-app\n      image: my-app:latest\n      env:\n        - name: AZURE_CLIENT_ID\n          value: "<client-id-of-managed-identity>"\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"usage-in-applications",children:"Usage in Applications"}),"\n",(0,s.jsx)(n.h3,{id:"python-example",children:"Python Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-python",children:'from azure.identity import ManagedIdentityCredential\nfrom azure.keyvault.secrets import SecretClient\n\n# Uses pod identity automatically\ncredential = ManagedIdentityCredential()\nclient = SecretClient(\n    vault_url="https://my-key-vault.vault.azure.net/",\n    credential=credential\n)\n\nsecret = client.get_secret("my-secret")\nprint(f"Secret value: {secret.value}")\n'})}),"\n",(0,s.jsx)(n.h3,{id:"net-example",children:".NET Example"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-csharp",children:'using Azure.Identity;\nusing Azure.Security.KeyVault.Secrets;\n\nvar credential = new ManagedIdentityCredential();\nvar client = new SecretClient(\n    new Uri("https://my-key-vault.vault.azure.net/"),\n    credential\n);\n\nKeyVaultSecret secret = await client.GetSecretAsync("my-secret");\nConsole.WriteLine($"Secret value: {secret.Value}");\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"security-best-practices",children:"Security Best Practices"}),"\n",(0,s.jsx)(n.h3,{id:"restrict-identity-assignment",children:"Restrict Identity Assignment"}),"\n",(0,s.jsx)(n.p,{children:"Use AzureIdentityBinding with specific namespaces:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: aadpodidentity.k8s.io/v1\nkind: AzureIdentityBinding\nmetadata:\n  name: my-app-identity-binding\n  namespace: production  # Only pods in this namespace can use this binding\nspec:\n  azureIdentity: my-app-identity\n  selector: my-app\n"})}),"\n",(0,s.jsx)(n.h3,{id:"use-exception-lists",children:"Use Exception Lists"}),"\n",(0,s.jsx)(n.p,{children:"Prevent pods from using certain identities:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: aadpodidentity.k8s.io/v1\nkind: AzurePodIdentityException\nmetadata:\n  name: mic-exception\n  namespace: kube-system\nspec:\n  podLabels:\n    app: mic\n    component: mic\n"})}),"\n",(0,s.jsx)(n.h3,{id:"monitor-identity-usage",children:"Monitor Identity Usage"}),"\n",(0,s.jsx)(n.p,{children:"Enable Azure Monitor logging:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'az monitor diagnostic-settings create \\\n  --name pod-identity-logs \\\n  --resource $RESOURCE_ID \\\n  --logs \'[{"category": "Audit", "enabled": true}]\' \\\n  --workspace <log-analytics-workspace-id>\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"migration-to-workload-identity",children:"Migration to Workload Identity"}),"\n",(0,s.jsx)(n.p,{children:"Microsoft recommends migrating to Azure AD Workload Identity, which is the successor to aad-pod-identity:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: my-app\n  annotations:\n    azure.workload.identity/client-id: "<client-id>"\n'})}),"\n",(0,s.jsx)(n.p,{children:"Workload Identity advantages:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Uses OIDC federation instead of IMDS interception."}),"\n",(0,s.jsx)(n.li,{children:"No privileged pods required."}),"\n",(0,s.jsx)(n.li,{children:"Better security isolation."}),"\n",(0,s.jsx)(n.li,{children:"Native AKS integration."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"troubleshooting",children:"Troubleshooting"}),"\n",(0,s.jsx)(n.h3,{id:"check-mic-logs",children:"Check MIC Logs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n kube-system -l app.kubernetes.io/component=mic\n"})}),"\n",(0,s.jsx)(n.h3,{id:"check-nmi-logs",children:"Check NMI Logs"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl logs -n kube-system -l app.kubernetes.io/component=nmi\n"})}),"\n",(0,s.jsx)(n.h3,{id:"verify-identity-assignment",children:"Verify Identity Assignment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl describe azureidentity my-app-identity\nkubectl describe azureidentitybinding my-app-identity-binding\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/Azure/aad-pod-identity",children:"aad-pod-identity GitHub Repository"})," - Microsoft Azure"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://learn.microsoft.com/en-us/azure/aks/use-azure-ad-pod-identity",children:"Use Azure AD Pod Identity"})," - Microsoft Documentation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://azure.github.io/azure-workload-identity/",children:"Azure AD Workload Identity"})," - Microsoft Documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(l,{...e})}):l(e)}},8453(e,n,i){i.d(n,{R:()=>r,x:()=>d});var t=i(6540);const s={},a=t.createContext(s);function r(e){const n=t.useContext(a);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),t.createElement(a.Provider,{value:n},e.children)}}}]);