"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[4860],{7158(e,n,i){i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>u,frontMatter:()=>r,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"best-practices/cluster-setup-and-hardening/rbac-and-identity/kube2iam","title":"kube2iam","description":"kube2iam enables Kubernetes pods to assume AWS IAM roles, providing fine-grained AWS credential management without exposing long-lived credentials.","source":"@site/docs/best-practices/cluster-setup-and-hardening/rbac-and-identity/kube2iam.md","sourceDirName":"best-practices/cluster-setup-and-hardening/rbac-and-identity","slug":"/best-practices/cluster-setup-and-hardening/rbac-and-identity/kube2iam","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/rbac-and-identity/kube2iam","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best-practices/cluster-setup-and-hardening/rbac-and-identity/kube2iam.md","tags":[{"inline":true,"label":"tool","permalink":"/kubernetes-security/tags/tool"},{"inline":true,"label":"rbac","permalink":"/kubernetes-security/tags/rbac"},{"inline":true,"label":"cloud-security","permalink":"/kubernetes-security/tags/cloud-security"},{"inline":true,"label":"AWS","permalink":"/kubernetes-security/tags/aws"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771236448000,"sidebarPosition":20,"frontMatter":{"sidebar_position":20,"title":"kube2iam","description":"kube2iam enables Kubernetes pods to assume AWS IAM roles, providing fine-grained AWS credential management without exposing long-lived credentials.","keywords":["kubernetes security tool","kube2iam","AWS IAM","pod identity","kubernetes AWS integration","IAM roles for pods","credential management","cloud security","CKS"],"tags":["tool","rbac","cloud-security","AWS"],"related":["/kubernetes-security/best-practices/cluster-setup-and-hardening/rbac-and-identity/kiam/","/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/cloud-metadata-mitigation/","/kubernetes-security/attack-vectors/cloud-metadata-service-abuse/"]},"sidebar":"default","previous":{"title":"kubernetes-rbac-audit","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/rbac-and-identity/kubernetes-rbac-audit"},"next":{"title":"kiam","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/rbac-and-identity/kiam"}}');var t=i(4848),a=i(8453);const r={sidebar_position:20,title:"kube2iam",description:"kube2iam enables Kubernetes pods to assume AWS IAM roles, providing fine-grained AWS credential management without exposing long-lived credentials.",keywords:["kubernetes security tool","kube2iam","AWS IAM","pod identity","kubernetes AWS integration","IAM roles for pods","credential management","cloud security","CKS"],tags:["tool","rbac","cloud-security","AWS"],related:["/kubernetes-security/best-practices/cluster-setup-and-hardening/rbac-and-identity/kiam/","/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/cloud-metadata-mitigation/","/kubernetes-security/attack-vectors/cloud-metadata-service-abuse/"]},o="kube2iam",l={},c=[{value:"How It Works",id:"how-it-works",level:2},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installation",id:"installation",level:2},{value:"Deploy kube2iam DaemonSet",id:"deploy-kube2iam-daemonset",level:3},{value:"Create Service Account and RBAC",id:"create-service-account-and-rbac",level:3},{value:"AWS IAM Configuration",id:"aws-iam-configuration",level:2},{value:"Node Role Trust Policy",id:"node-role-trust-policy",level:3},{value:"Pod Role Trust Policy",id:"pod-role-trust-policy",level:3},{value:"Usage",id:"usage",level:2},{value:"Annotate Pods with IAM Role",id:"annotate-pods-with-iam-role",level:3},{value:"Annotate Deployments",id:"annotate-deployments",level:3},{value:"Restrict Roles by Namespace",id:"restrict-roles-by-namespace",level:3},{value:"Security Considerations",id:"security-considerations",level:2},{value:"Limitations",id:"limitations",level:3},{value:"Recommendations",id:"recommendations",level:3},{value:"Migration to IRSA",id:"migration-to-irsa",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"kube2iam",children:"kube2iam"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"kube2iam"})," provides AWS IAM credential isolation for Kubernetes pods. It intercepts calls to the AWS EC2 metadata service and returns temporary credentials for pod-specific IAM roles, allowing different pods to assume different AWS roles without sharing node-level credentials."]}),"\n",(0,t.jsx)(n.p,{children:"This approach follows the principle of least privilege by ensuring each workload has only the AWS permissions it needs."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"how-it-works",children:"How It Works"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsx)(n.li,{children:"kube2iam runs as a DaemonSet on each node."}),"\n",(0,t.jsx)(n.li,{children:"Pods are annotated with the IAM role they should assume."}),"\n",(0,t.jsx)(n.li,{children:"When a pod requests credentials from the metadata service (169.254.169.254), kube2iam intercepts the request."}),"\n",(0,t.jsx)(n.li,{children:"kube2iam assumes the specified IAM role and returns temporary credentials to the pod."}),"\n",(0,t.jsx)(n.li,{children:"The pod uses these credentials for AWS API calls."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"AWS IAM roles configured with trust policies allowing the Kubernetes nodes to assume them."}),"\n",(0,t.jsx)(n.li,{children:"iptables rules to redirect metadata service traffic to kube2iam."}),"\n",(0,t.jsx)(n.li,{children:"Node IAM role with permission to assume the target pod roles."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,t.jsx)(n.h3,{id:"deploy-kube2iam-daemonset",children:"Deploy kube2iam DaemonSet"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: kube2iam\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      name: kube2iam\n  template:\n    metadata:\n      labels:\n        name: kube2iam\n    spec:\n      hostNetwork: true\n      serviceAccountName: kube2iam\n      containers:\n        - name: kube2iam\n          image: jtblin/kube2iam:latest\n          args:\n            - "--base-role-arn=arn:aws:iam::123456789012:role/"\n            - "--iptables=true"\n            - "--host-ip=$(HOST_IP)"\n            - "--host-interface=eni+"\n            - "--verbose"\n          env:\n            - name: HOST_IP\n              valueFrom:\n                fieldRef:\n                  fieldPath: status.podIP\n          ports:\n            - containerPort: 8181\n          securityContext:\n            privileged: true\n'})}),"\n",(0,t.jsx)(n.h3,{id:"create-service-account-and-rbac",children:"Create Service Account and RBAC"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: kube2iam\n  namespace: kube-system\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: kube2iam\nrules:\n  - apiGroups: [""]\n    resources: ["namespaces", "pods"]\n    verbs: ["get", "watch", "list"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kube2iam\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: kube2iam\nsubjects:\n  - kind: ServiceAccount\n    name: kube2iam\n    namespace: kube-system\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"aws-iam-configuration",children:"AWS IAM Configuration"}),"\n",(0,t.jsx)(n.h3,{id:"node-role-trust-policy",children:"Node Role Trust Policy"}),"\n",(0,t.jsx)(n.p,{children:"The node IAM role must be able to assume the pod roles:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": "sts:AssumeRole",\n      "Resource": "arn:aws:iam::123456789012:role/k8s-*"\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.h3,{id:"pod-role-trust-policy",children:"Pod Role Trust Policy"}),"\n",(0,t.jsx)(n.p,{children:"Each pod role must trust the node role:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "AWS": "arn:aws:iam::123456789012:role/kubernetes-node-role"\n      },\n      "Action": "sts:AssumeRole"\n    }\n  ]\n}\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsx)(n.h3,{id:"annotate-pods-with-iam-role",children:"Annotate Pods with IAM Role"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: my-app\n  annotations:\n    iam.amazonaws.com/role: k8s-my-app-role\nspec:\n  containers:\n    - name: my-app\n      image: my-app:latest\n"})}),"\n",(0,t.jsx)(n.h3,{id:"annotate-deployments",children:"Annotate Deployments"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: Deployment\nmetadata:\n  name: my-app\nspec:\n  template:\n    metadata:\n      annotations:\n        iam.amazonaws.com/role: k8s-my-app-role\n    spec:\n      containers:\n        - name: my-app\n          image: my-app:latest\n"})}),"\n",(0,t.jsx)(n.h3,{id:"restrict-roles-by-namespace",children:"Restrict Roles by Namespace"}),"\n",(0,t.jsx)(n.p,{children:"Use namespace annotations to restrict which roles can be assumed:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Namespace\nmetadata:\n  name: production\n  annotations:\n    iam.amazonaws.com/allowed-roles: '[\"k8s-production-*\"]'\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"security-considerations",children:"Security Considerations"}),"\n",(0,t.jsx)(n.h3,{id:"limitations",children:"Limitations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Uses iptables rules which can be bypassed by privileged containers."}),"\n",(0,t.jsx)(n.li,{children:"Relies on the EC2 metadata service endpoint."}),"\n",(0,t.jsx)(n.li,{children:"Single point of failure if kube2iam pods crash."}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"recommendations",children:"Recommendations"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Restrict namespace roles:"})," Use allowed-roles annotations to limit role assumption per namespace."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Use network policies:"})," Prevent pods from bypassing kube2iam."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Monitor assume role events:"})," Track role assumption in AWS CloudTrail."]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Consider alternatives:"})," AWS now offers IAM Roles for Service Accounts (IRSA) which is more secure."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"migration-to-irsa",children:"Migration to IRSA"}),"\n",(0,t.jsx)(n.p,{children:"AWS recommends migrating to IAM Roles for Service Accounts (IRSA) for better security:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: my-app\n  annotations:\n    eks.amazonaws.com/role-arn: arn:aws:iam::123456789012:role/my-app-role\n"})}),"\n",(0,t.jsx)(n.p,{children:"IRSA advantages over kube2iam:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Does not require privileged containers."}),"\n",(0,t.jsx)(n.li,{children:"Uses OIDC federation instead of metadata service."}),"\n",(0,t.jsx)(n.li,{children:"No iptables manipulation required."}),"\n",(0,t.jsx)(n.li,{children:"Better credential isolation."}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/jtblin/kube2iam",children:"kube2iam GitHub Repository"})," - GitHub"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html",children:"IAM Roles for Service Accounts"})," - AWS Documentation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html",children:"Instance Metadata and User Data"})," - AWS Documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,i){i.d(n,{R:()=>r,x:()=>o});var s=i(6540);const t={},a=s.createContext(t);function r(e){const n=s.useContext(a);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:r(e.components),s.createElement(a.Provider,{value:n},e.children)}}}]);