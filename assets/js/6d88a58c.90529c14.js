"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[5372],{345(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>o,default:()=>d,frontMatter:()=>a,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"best-practices/cluster-setup-and-hardening/api-server-security/opa-gatekeeper","title":"Open Policy Agent (OPA) / Gatekeeper","description":"OPA and Gatekeeper bring policy-based governance to Kubernetes, enabling fine-grained access control, resource validation, and compliance enforcement.","source":"@site/docs/best-practices/cluster-setup-and-hardening/api-server-security/opa-gatekeeper.md","sourceDirName":"best-practices/cluster-setup-and-hardening/api-server-security","slug":"/best-practices/cluster-setup-and-hardening/api-server-security/opa-gatekeeper","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/api-server-security/opa-gatekeeper","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best-practices/cluster-setup-and-hardening/api-server-security/opa-gatekeeper.md","tags":[],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771236448000,"sidebarPosition":3,"frontMatter":{"title":"Open Policy Agent (OPA) / Gatekeeper","description":"OPA and Gatekeeper bring policy-based governance to Kubernetes, enabling fine-grained access control, resource validation, and compliance enforcement.","sidebar_position":3,"keywords":["kubernetes security tool","OPA","open policy agent","gatekeeper","kubernetes policy","admission control","policy enforcement","rego","kubernetes governance","compliance","CKS"]},"sidebar":"default","previous":{"title":"Securing Kubernetes Admission Controllers","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/api-server-security/misconfigured-admission-controllers-mitigation"},"next":{"title":"Kyverno","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/api-server-security/kyverno"}}');var t=s(4848),i=s(8453);const a={title:"Open Policy Agent (OPA) / Gatekeeper",description:"OPA and Gatekeeper bring policy-based governance to Kubernetes, enabling fine-grained access control, resource validation, and compliance enforcement.",sidebar_position:3,keywords:["kubernetes security tool","OPA","open policy agent","gatekeeper","kubernetes policy","admission control","policy enforcement","rego","kubernetes governance","compliance","CKS"]},o="Open Policy Agent (OPA) / Gatekeeper",c={},l=[{value:"Usage",id:"usage",level:2},{value:"1. Install Gatekeeper in Your Cluster",id:"1-install-gatekeeper-in-your-cluster",level:3},{value:"2. Define a Constraint Template",id:"2-define-a-constraint-template",level:3},{value:"3. Apply a Constraint",id:"3-apply-a-constraint",level:3},{value:"4. Test the Policy",id:"4-test-the-policy",level:3},{value:"Best Practices",id:"best-practices",level:2},{value:"References",id:"references",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"open-policy-agent-opa--gatekeeper",children:"Open Policy Agent (OPA) / Gatekeeper"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Required knowledge for the CKS certification."})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Open Policy Agent (OPA)"})," is a ",(0,t.jsx)(n.strong,{children:"general-purpose policy engine"})," that uses a declarative language called ",(0,t.jsx)(n.strong,{children:"Rego"})," to define and enforce rules across systems. In Kubernetes, OPA integrates through ",(0,t.jsx)(n.strong,{children:"Gatekeeper"}),", a controller that acts as an ",(0,t.jsx)(n.strong,{children:"admission webhook"}),", intercepting API server requests and enforcing policies before resources are created or modified."]}),"\n",(0,t.jsxs)(n.p,{children:["With OPA/Gatekeeper, teams can ensure ",(0,t.jsx)(n.strong,{children:"consistent security, compliance, and operational practices"})," by defining custom rules for how Kubernetes resources should behave."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,t.jsx)(n.h3,{id:"1-install-gatekeeper-in-your-cluster",children:"1. Install Gatekeeper in Your Cluster"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl apply -f https://raw.githubusercontent.com/open-policy-agent/gatekeeper/release-3.14/deploy/gatekeeper.yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:"Verify installation:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get pods -n gatekeeper-system\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"2-define-a-constraint-template",children:"2. Define a Constraint Template"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: templates.gatekeeper.sh/v1beta1\nkind: ConstraintTemplate\nmetadata:\n  name: k8srequiredlabels\nspec:\n  crd:\n    spec:\n      names:\n        kind: K8sRequiredLabels\n  targets:\n    - target: admission.k8s.gatekeeper.sh\n      rego: |\n        package k8srequiredlabels\n\n        violation[{"msg": msg}] {\n          required := {"app"}\n          provided := {label | input.review.object.metadata.labels[label]}\n          missing := required - provided\n          count(missing) > 0\n          msg := sprintf("Missing required labels: %v", [missing])\n        }\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"3-apply-a-constraint",children:"3. Apply a Constraint"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: constraints.gatekeeper.sh/v1beta1\nkind: K8sRequiredLabels\nmetadata:\n  name: must-have-app-label\nspec:\n  match:\n    kinds:\n      - apiGroups: [""]\n        kinds: ["Pod"]\n'})}),"\n",(0,t.jsxs)(n.p,{children:["This constraint ensures every Pod has an ",(0,t.jsx)(n.code,{children:"app"})," label."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h3,{id:"4-test-the-policy",children:"4. Test the Policy"}),"\n",(0,t.jsx)(n.p,{children:"Try creating a pod without the required label:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl run test --image=nginx\n"})}),"\n",(0,t.jsx)(n.p,{children:"Gatekeeper will deny the request with a message explaining the violation."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"best-practices",children:"Best Practices"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.strong,{children:"Constraint Templates"})," to define reusable policy logic and ",(0,t.jsx)(n.strong,{children:"Constraints"})," to enforce them."]}),"\n",(0,t.jsxs)(n.li,{children:["Store policies in ",(0,t.jsx)(n.strong,{children:"version-controlled repositories"})," and apply them through GitOps pipelines."]}),"\n",(0,t.jsxs)(n.li,{children:["Regularly audit applied constraints using Gatekeeper\u2019s ",(0,t.jsx)(n.strong,{children:"audit functionality"}),"."]}),"\n",(0,t.jsxs)(n.li,{children:["Use ",(0,t.jsx)(n.strong,{children:"OPA outside of Kubernetes"})," to enforce policies in CI/CD pipelines, Terraform, APIs, and more."]}),"\n",(0,t.jsxs)(n.li,{children:["Validate configurations with ",(0,t.jsx)(n.strong,{children:"dry-run mode"})," before enforcing policies in production."]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://www.openpolicyagent.org/docs/latest/",children:"Open Policy Agent Documentation"})," - Open Policy Agent"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/open-policy-agent/gatekeeper",children:"Gatekeeper GitHub Repository"})," - CNCF"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://open-policy-agent.github.io/gatekeeper-library/website/",children:"Gatekeeper Policy Library"})," - Open Policy Agent"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(p,{...e})}):p(e)}},8453(e,n,s){s.d(n,{R:()=>a,x:()=>o});var r=s(6540);const t={},i=r.createContext(t);function a(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);