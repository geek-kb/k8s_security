"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[2494],{8158(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>d,frontMatter:()=>r,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"best-practices/cluster-setup-and-hardening/node-security/kubelet-authentication","title":"Securing Kubelet Authentication and Authorization","description":"How to disable kubelet anonymous authentication, configure certificate-based authentication, and implement proper authorization to protect Kubernetes nodes.","source":"@site/docs/best-practices/cluster-setup-and-hardening/node-security/kubelet-authentication.md","sourceDirName":"best-practices/cluster-setup-and-hardening/node-security","slug":"/best-practices/cluster-setup-and-hardening/node-security/kubelet-authentication","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/node-security/kubelet-authentication","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best-practices/cluster-setup-and-hardening/node-security/kubelet-authentication.md","tags":[{"inline":true,"label":"best-practice","permalink":"/kubernetes-security/tags/best-practice"},{"inline":true,"label":"mitigation","permalink":"/kubernetes-security/tags/mitigation"},{"inline":true,"label":"node-security","permalink":"/kubernetes-security/tags/node-security"},{"inline":true,"label":"kubelet","permalink":"/kubernetes-security/tags/kubelet"},{"inline":true,"label":"CKS","permalink":"/kubernetes-security/tags/cks"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771236448000,"sidebarPosition":8,"frontMatter":{"sidebar_position":8,"title":"Securing Kubelet Authentication and Authorization","description":"How to disable kubelet anonymous authentication, configure certificate-based authentication, and implement proper authorization to protect Kubernetes nodes.","keywords":["kubernetes security best practices","kubelet authentication","kubelet authorization","anonymous authentication","kubelet security","node security","CIS benchmark kubelet","webhook authorization","CKS"],"tags":["best-practice","mitigation","node-security","kubelet","CKS"],"related":["/kubernetes-security/attack-vectors/kubelet-anonymous-auth/","/kubernetes-security/attack-vectors/exposed-kubelet-api/","/kubernetes-security/best-practices/cluster-setup-and-hardening/cis/cis-benchmark-for-k8s/"]},"sidebar":"default","previous":{"title":"Changed Block Tracking for Volume Snapshots","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/node-security/changed-block-tracking"},"next":{"title":"AppArmor Profiles","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/pod-security/app-armor-profiles"}}');var s=t(4848),a=t(8453);const r={sidebar_position:8,title:"Securing Kubelet Authentication and Authorization",description:"How to disable kubelet anonymous authentication, configure certificate-based authentication, and implement proper authorization to protect Kubernetes nodes.",keywords:["kubernetes security best practices","kubelet authentication","kubelet authorization","anonymous authentication","kubelet security","node security","CIS benchmark kubelet","webhook authorization","CKS"],tags:["best-practice","mitigation","node-security","kubelet","CKS"],related:["/kubernetes-security/attack-vectors/kubelet-anonymous-auth/","/kubernetes-security/attack-vectors/exposed-kubelet-api/","/kubernetes-security/best-practices/cluster-setup-and-hardening/cis/cis-benchmark-for-k8s/"]},o="Securing Kubelet Authentication and Authorization",l={},c=[{value:"1. Disable Anonymous Authentication",id:"1-disable-anonymous-authentication",level:2},{value:"Kubelet Configuration File",id:"kubelet-configuration-file",level:3},{value:"Command Line Flags (Alternative)",id:"command-line-flags-alternative",level:3},{value:"Verify Configuration",id:"verify-configuration",level:3},{value:"2. Configure Certificate-Based Authentication",id:"2-configure-certificate-based-authentication",level:2},{value:"Generate Client Certificates",id:"generate-client-certificates",level:3},{value:"Configure Kubelet to Require Client Certificates",id:"configure-kubelet-to-require-client-certificates",level:3},{value:"3. Enable Webhook Authorization",id:"3-enable-webhook-authorization",level:2},{value:"Configure Authorization Mode",id:"configure-authorization-mode",level:3},{value:"Create RBAC Rules for Kubelet Access",id:"create-rbac-rules-for-kubelet-access",level:3},{value:"4. Restrict Network Access to Kubelet Port",id:"4-restrict-network-access-to-kubelet-port",level:2},{value:"Host Firewall Rules (iptables)",id:"host-firewall-rules-iptables",level:3},{value:"Cloud Security Groups",id:"cloud-security-groups",level:3},{value:"5. Disable Read-Only Port",id:"5-disable-read-only-port",level:2},{value:"Kubelet Configuration",id:"kubelet-configuration",level:3},{value:"Command Line",id:"command-line",level:3},{value:"Verify Disabled",id:"verify-disabled",level:3},{value:"6. Audit Kubelet Access",id:"6-audit-kubelet-access",level:2},{value:"Enable Kubelet Audit Logging",id:"enable-kubelet-audit-logging",level:3},{value:"Monitor with Falco",id:"monitor-with-falco",level:3},{value:"Security Checklist",id:"security-checklist",level:2},{value:"References",id:"references",level:2}];function u(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"securing-kubelet-authentication-and-authorization",children:"Securing Kubelet Authentication and Authorization"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Required knowledge for the CKS certification."})}),"\n",(0,s.jsx)(n.p,{children:"The kubelet exposes an API on port 10250 that allows executing commands in containers, reading logs, and accessing pod information. By default, the kubelet may allow anonymous authentication, creating a significant security risk if the kubelet API is accessible from the network."}),"\n",(0,s.jsx)(n.p,{children:"This guide covers how to properly configure kubelet authentication and authorization to prevent unauthorized access to nodes."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"1-disable-anonymous-authentication",children:"1. Disable Anonymous Authentication"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," When anonymous authentication is enabled, any request to the kubelet API is accepted without credentials.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Explicitly disable anonymous authentication in the kubelet configuration."]}),"\n",(0,s.jsx)(n.h3,{id:"kubelet-configuration-file",children:"Kubelet Configuration File"}),"\n",(0,s.jsxs)(n.p,{children:["Create or modify ",(0,s.jsx)(n.code,{children:"/var/lib/kubelet/config.yaml"}),":"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nauthentication:\n  anonymous:\n    enabled: false\n  webhook:\n    enabled: true\n    cacheTTL: 2m0s\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.crt\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\n"})}),"\n",(0,s.jsx)(n.h3,{id:"command-line-flags-alternative",children:"Command Line Flags (Alternative)"}),"\n",(0,s.jsx)(n.p,{children:"If using command-line configuration:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubelet \\\n  --anonymous-auth=false \\\n  --client-ca-file=/etc/kubernetes/pki/ca.crt \\\n  --authorization-mode=Webhook\n"})}),"\n",(0,s.jsx)(n.h3,{id:"verify-configuration",children:"Verify Configuration"}),"\n",(0,s.jsx)(n.p,{children:"Check the kubelet's current authentication settings:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl -sk https://localhost:10250/configz | jq '.authentication'\n"})}),"\n",(0,s.jsxs)(n.p,{children:["Expected output should show ",(0,s.jsx)(n.code,{children:"anonymous.enabled: false"}),"."]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"2-configure-certificate-based-authentication",children:"2. Configure Certificate-Based Authentication"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," Without proper client certificate authentication, any client with network access can attempt to authenticate.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Configure x509 client certificate authentication."]}),"\n",(0,s.jsx)(n.h3,{id:"generate-client-certificates",children:"Generate Client Certificates"}),"\n",(0,s.jsx)(n.p,{children:"Use the Kubernetes CA to sign client certificates:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'openssl genrsa -out kubelet-client.key 2048\n\nopenssl req -new -key kubelet-client.key \\\n  -subj "/O=system:nodes/CN=system:node:worker-1" \\\n  -out kubelet-client.csr\n\nopenssl x509 -req -in kubelet-client.csr \\\n  -CA /etc/kubernetes/pki/ca.crt \\\n  -CAkey /etc/kubernetes/pki/ca.key \\\n  -CAcreateserial \\\n  -out kubelet-client.crt \\\n  -days 365\n'})}),"\n",(0,s.jsx)(n.h3,{id:"configure-kubelet-to-require-client-certificates",children:"Configure Kubelet to Require Client Certificates"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nauthentication:\n  x509:\n    clientCAFile: /etc/kubernetes/pki/ca.crt\n  anonymous:\n    enabled: false\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"3-enable-webhook-authorization",children:"3. Enable Webhook Authorization"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," Even with authentication, the kubelet may allow all authenticated users full access.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Configure Webhook authorization to delegate authorization decisions to the API server."]}),"\n",(0,s.jsx)(n.h3,{id:"configure-authorization-mode",children:"Configure Authorization Mode"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nauthorization:\n  mode: Webhook\n  webhook:\n    cacheAuthorizedTTL: 5m0s\n    cacheUnauthorizedTTL: 30s\n"})}),"\n",(0,s.jsx)(n.h3,{id:"create-rbac-rules-for-kubelet-access",children:"Create RBAC Rules for Kubelet Access"}),"\n",(0,s.jsx)(n.p,{children:"Limit who can access the kubelet API:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: kubelet-api-access\nrules:\n  - apiGroups: [""]\n    resources: ["nodes/proxy"]\n    verbs: ["get"]\n  - apiGroups: [""]\n    resources: ["nodes/log", "nodes/metrics"]\n    verbs: ["get"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: kubelet-api-admin\nsubjects:\n  - kind: User\n    name: admin\n    apiGroup: rbac.authorization.k8s.io\nroleRef:\n  kind: ClusterRole\n  name: kubelet-api-access\n  apiGroup: rbac.authorization.k8s.io\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"4-restrict-network-access-to-kubelet-port",children:"4. Restrict Network Access to Kubelet Port"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," The kubelet API port (10250) may be accessible from pods or external networks.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Use network policies and firewall rules to restrict access."]}),"\n",(0,s.jsx)(n.h3,{id:"host-firewall-rules-iptables",children:"Host Firewall Rules (iptables)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"# Allow only control plane nodes to access kubelet\niptables -A INPUT -p tcp --dport 10250 -s 10.0.0.10 -j ACCEPT\niptables -A INPUT -p tcp --dport 10250 -s 10.0.0.11 -j ACCEPT\niptables -A INPUT -p tcp --dport 10250 -j DROP\n"})}),"\n",(0,s.jsx)(n.h3,{id:"cloud-security-groups",children:"Cloud Security Groups"}),"\n",(0,s.jsx)(n.p,{children:"For cloud environments, configure security groups to allow port 10250 only from:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Control plane nodes"}),"\n",(0,s.jsx)(n.li,{children:"Monitoring systems (if required)"}),"\n"]}),"\n",(0,s.jsx)(n.p,{children:"Block access from:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Pod networks"}),"\n",(0,s.jsx)(n.li,{children:"External networks"}),"\n",(0,s.jsx)(n.li,{children:"Other worker nodes (unless required)"}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"5-disable-read-only-port",children:"5. Disable Read-Only Port"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," The kubelet read-only port (10255) exposes information without authentication.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Disable the read-only port entirely."]}),"\n",(0,s.jsx)(n.h3,{id:"kubelet-configuration",children:"Kubelet Configuration"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: kubelet.config.k8s.io/v1beta1\nkind: KubeletConfiguration\nreadOnlyPort: 0\n"})}),"\n",(0,s.jsx)(n.h3,{id:"command-line",children:"Command Line"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubelet --read-only-port=0\n"})}),"\n",(0,s.jsx)(n.h3,{id:"verify-disabled",children:"Verify Disabled"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"curl http://localhost:10255/healthz\n# Should fail with connection refused\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"6-audit-kubelet-access",children:"6. Audit Kubelet Access"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Issue:"})," Unauthorized kubelet access attempts may go undetected.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(n.strong,{children:"Fix:"})," Enable audit logging and monitor kubelet access."]}),"\n",(0,s.jsx)(n.h3,{id:"enable-kubelet-audit-logging",children:"Enable Kubelet Audit Logging"}),"\n",(0,s.jsx)(n.p,{children:"Add to API server audit policy:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: audit.k8s.io/v1\nkind: Policy\nrules:\n  - level: RequestResponse\n    resources:\n      - group: ""\n        resources: ["nodes/proxy", "nodes/log", "nodes/exec"]\n    verbs: ["create", "get"]\n'})}),"\n",(0,s.jsx)(n.h3,{id:"monitor-with-falco",children:"Monitor with Falco"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"- rule: Unauthorized Kubelet API Access\n  desc: Detect attempts to access kubelet API\n  condition: >\n    evt.type = connect and \n    fd.sport = 10250 and\n    not proc.name in (kubelet, kube-apiserver)\n  output: >\n    Suspicious kubelet API access (process=%proc.name \n    connection=%fd.name user=%user.name)\n  priority: WARNING\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"security-checklist",children:"Security Checklist"}),"\n",(0,s.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Anonymous authentication disabled (",(0,s.jsx)(n.code,{children:"anonymous.enabled: false"}),")"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Webhook authentication enabled"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","x509 client CA file configured"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Webhook authorization mode enabled"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Read-only port disabled (",(0,s.jsx)(n.code,{children:"readOnlyPort: 0"}),")"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Firewall rules restrict access to port 10250"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Audit logging enabled for kubelet access"]}),"\n",(0,s.jsxs)(n.li,{className:"task-list-item",children:[(0,s.jsx)(n.input,{type:"checkbox",disabled:!0})," ","Regular review of kubelet configuration"]}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/access-authn-authz/kubelet-authn-authz/",children:"Kubelet Authentication/Authorization"})," - Kubernetes Documentation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://www.cisecurity.org/benchmark/kubernetes",children:"CIS Kubernetes Benchmark"})," - Center for Internet Security"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://kubernetes.io/docs/reference/config-api/kubelet-config.v1beta1/",children:"Kubelet Configuration"})," - Kubernetes Documentation"]}),"\n"]})]})}function d(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(u,{...e})}):u(e)}},8453(e,n,t){t.d(n,{R:()=>r,x:()=>o});var i=t(6540);const s={},a=i.createContext(s);function r(e){const n=i.useContext(a);return i.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:r(e.components),i.createElement(a.Provider,{value:n},e.children)}}}]);