"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[2698],{5117(e,n,s){s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>o,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"best-practices/cluster-setup-and-hardening/network-security/egress-control","title":"Egress Control in Kubernetes","description":"Restrict and monitor outbound traffic from Kubernetes workloads to prevent data exfiltration, command-and-control communication, and unauthorized external access.","source":"@site/docs/best-practices/cluster-setup-and-hardening/network-security/egress-control.md","sourceDirName":"best-practices/cluster-setup-and-hardening/network-security","slug":"/best-practices/cluster-setup-and-hardening/network-security/egress-control","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/egress-control","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best-practices/cluster-setup-and-hardening/network-security/egress-control.md","tags":[{"inline":true,"label":"best-practice","permalink":"/kubernetes-security/tags/best-practice"},{"inline":true,"label":"network","permalink":"/kubernetes-security/tags/network"},{"inline":true,"label":"egress","permalink":"/kubernetes-security/tags/egress"},{"inline":true,"label":"network-policies","permalink":"/kubernetes-security/tags/network-policies"},{"inline":true,"label":"CKS","permalink":"/kubernetes-security/tags/cks"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771236448000,"sidebarPosition":4,"frontMatter":{"title":"Egress Control in Kubernetes","description":"Restrict and monitor outbound traffic from Kubernetes workloads to prevent data exfiltration, command-and-control communication, and unauthorized external access.","sidebar_position":4,"keywords":["kubernetes security best practices","egress control","outbound traffic","network policies","data exfiltration prevention","egress gateway","kubernetes networking","traffic monitoring","zero trust egress","CKS"],"tags":["best-practice","network","egress","network-policies","CKS"],"related":["/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/network-policies/","/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/dns-security/","/kubernetes-security/attack-vectors/cloud-metadata-service-abuse/"]},"sidebar":"default","previous":{"title":"DNS Security in Kubernetes","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/dns-security"},"next":{"title":"How to Secure Kubernetes Dashboard: Authentication, RBAC & Network Policies","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/exposed-dashboard-mitigation"}}');var r=s(4848),i=s(8453);const o={title:"Egress Control in Kubernetes",description:"Restrict and monitor outbound traffic from Kubernetes workloads to prevent data exfiltration, command-and-control communication, and unauthorized external access.",sidebar_position:4,keywords:["kubernetes security best practices","egress control","outbound traffic","network policies","data exfiltration prevention","egress gateway","kubernetes networking","traffic monitoring","zero trust egress","CKS"],tags:["best-practice","network","egress","network-policies","CKS"],related:["/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/network-policies/","/kubernetes-security/best-practices/cluster-setup-and-hardening/network-security/dns-security/","/kubernetes-security/attack-vectors/cloud-metadata-service-abuse/"]},a="Egress Control in Kubernetes",c={},l=[{value:"1. Default Deny Egress Policies",id:"1-default-deny-egress-policies",level:2},{value:"Deny All Egress",id:"deny-all-egress",level:3},{value:"Allow Specific Destinations",id:"allow-specific-destinations",level:3},{value:"2. Block Cloud Metadata Service",id:"2-block-cloud-metadata-service",level:2},{value:"Block Metadata Access",id:"block-metadata-access",level:3},{value:"3. Egress Gateways",id:"3-egress-gateways",level:2},{value:"Istio Egress Gateway",id:"istio-egress-gateway",level:3},{value:"4. FQDN-Based Egress Policies",id:"4-fqdn-based-egress-policies",level:2},{value:"Cilium FQDN Policy",id:"cilium-fqdn-policy",level:3},{value:"5. Proxy-Based Egress Control",id:"5-proxy-based-egress-control",level:2},{value:"Squid Proxy Configuration",id:"squid-proxy-configuration",level:3},{value:"Configure Pods to Use Proxy",id:"configure-pods-to-use-proxy",level:3},{value:"6. Monitor Egress Traffic",id:"6-monitor-egress-traffic",level:2},{value:"Cilium Hubble Observability",id:"cilium-hubble-observability",level:3},{value:"Alerting on Suspicious Egress",id:"alerting-on-suspicious-egress",level:3},{value:"7. Cloud Firewall Integration",id:"7-cloud-firewall-integration",level:2},{value:"AWS Security Group",id:"aws-security-group",level:3},{value:"Conclusion",id:"conclusion",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"egress-control-in-kubernetes",children:"Egress Control in Kubernetes"})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Egress control"})," restricts ",(0,r.jsx)(n.strong,{children:"outbound traffic"})," from Kubernetes pods to external destinations. Without egress controls, compromised pods can freely communicate with attacker infrastructure, exfiltrate data, or abuse cloud metadata services."]}),"\n",(0,r.jsxs)(n.p,{children:["Implementing egress controls is a fundamental part of ",(0,r.jsx)(n.strong,{children:"defense in depth"})," and ",(0,r.jsx)(n.strong,{children:"zero-trust networking"}),"."]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"1-default-deny-egress-policies",children:"1. Default Deny Egress Policies"}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Required knowledge for the CKS certification."})}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," By default, Kubernetes pods can initiate connections to any external IP address, allowing compromised workloads to exfiltrate data or contact command-and-control servers.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Implement default-deny egress policies and explicitly allow only required outbound traffic."]}),"\n",(0,r.jsx)(n.h3,{id:"deny-all-egress",children:"Deny All Egress"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: default-deny-egress\n  namespace: production\nspec:\n  podSelector: {}\n  policyTypes:\n    - Egress\n"})}),"\n",(0,r.jsx)(n.h3,{id:"allow-specific-destinations",children:"Allow Specific Destinations"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: allow-specific-egress\n  namespace: production\nspec:\n  podSelector:\n    matchLabels:\n      app: backend\n  policyTypes:\n    - Egress\n  egress:\n    - to:\n        - namespaceSelector:\n            matchLabels:\n              kubernetes.io/metadata.name: kube-system\n          podSelector:\n            matchLabels:\n              k8s-app: kube-dns\n      ports:\n        - protocol: UDP\n          port: 53\n        - protocol: TCP\n          port: 53\n    - to:\n        - ipBlock:\n            cidr: 10.0.0.0/8\n    - to:\n        - ipBlock:\n            cidr: 203.0.113.0/24\n      ports:\n        - protocol: TCP\n          port: 443\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"2-block-cloud-metadata-service",children:"2. Block Cloud Metadata Service"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," Pods can access cloud metadata endpoints (169.254.169.254) to steal IAM credentials, access secrets, and pivot to other cloud resources.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Explicitly block access to cloud metadata service IP addresses in egress policies."]}),"\n",(0,r.jsx)(n.h3,{id:"block-metadata-access",children:"Block Metadata Access"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.k8s.io/v1\nkind: NetworkPolicy\nmetadata:\n  name: block-metadata-service\n  namespace: production\nspec:\n  podSelector: {}\n  policyTypes:\n    - Egress\n  egress:\n    - to:\n        - ipBlock:\n            cidr: 0.0.0.0/0\n            except:\n              - 169.254.169.254/32\n              - 169.254.170.2/32\n"})}),"\n",(0,r.jsx)(n.p,{children:(0,r.jsx)(n.strong,{children:"Metadata endpoints to block:"})}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["AWS EC2/EKS: ",(0,r.jsx)(n.code,{children:"169.254.169.254"})]}),"\n",(0,r.jsxs)(n.li,{children:["AWS ECS: ",(0,r.jsx)(n.code,{children:"169.254.170.2"})]}),"\n",(0,r.jsxs)(n.li,{children:["GCP: ",(0,r.jsx)(n.code,{children:"169.254.169.254"})]}),"\n",(0,r.jsxs)(n.li,{children:["Azure: ",(0,r.jsx)(n.code,{children:"169.254.169.254"})]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"3-egress-gateways",children:"3. Egress Gateways"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," Distributed egress makes it difficult to monitor, log, and control all outbound traffic from the cluster.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Route egress traffic through centralized gateways for consistent logging, policy enforcement, and IP allowlisting."]}),"\n",(0,r.jsx)(n.h3,{id:"istio-egress-gateway",children:"Istio Egress Gateway"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: networking.istio.io/v1beta1\nkind: Gateway\nmetadata:\n  name: egress-gateway\n  namespace: istio-system\nspec:\n  selector:\n    istio: egressgateway\n  servers:\n    - port:\n        number: 443\n        name: https\n        protocol: HTTPS\n      hosts:\n        - api.external-service.com\n      tls:\n        mode: PASSTHROUGH\n---\napiVersion: networking.istio.io/v1beta1\nkind: VirtualService\nmetadata:\n  name: external-api\n  namespace: production\nspec:\n  hosts:\n    - api.external-service.com\n  gateways:\n    - mesh\n    - istio-system/egress-gateway\n  tls:\n    - match:\n        - gateways:\n            - mesh\n          port: 443\n          sniHosts:\n            - api.external-service.com\n      route:\n        - destination:\n            host: istio-egressgateway.istio-system.svc.cluster.local\n            port:\n              number: 443\n"})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"4-fqdn-based-egress-policies",children:"4. FQDN-Based Egress Policies"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," IP-based egress policies are difficult to maintain when external services use dynamic IPs or CDNs.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Use FQDN-based policies (Cilium) to allow egress based on domain names instead of IP addresses."]}),"\n",(0,r.jsx)(n.h3,{id:"cilium-fqdn-policy",children:"Cilium FQDN Policy"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: cilium.io/v2\nkind: CiliumNetworkPolicy\nmetadata:\n  name: allow-github-egress\n  namespace: ci-cd\nspec:\n  endpointSelector:\n    matchLabels:\n      app: build-agent\n  egress:\n    - toEndpoints:\n        - matchLabels:\n            k8s:io.kubernetes.pod.namespace: kube-system\n            k8s-app: kube-dns\n      toPorts:\n        - ports:\n            - port: "53"\n              protocol: UDP\n          rules:\n            dns:\n              - matchPattern: "*.github.com"\n              - matchPattern: "*.githubusercontent.com"\n    - toFQDNs:\n        - matchPattern: "*.github.com"\n        - matchPattern: "*.githubusercontent.com"\n      toPorts:\n        - ports:\n            - port: "443"\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"5-proxy-based-egress-control",children:"5. Proxy-Based Egress Control"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," Network policies cannot inspect HTTP traffic content or enforce URL-level restrictions.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Route HTTP/HTTPS traffic through a forward proxy to enable domain allowlisting and request logging."]}),"\n",(0,r.jsx)(n.h3,{id:"squid-proxy-configuration",children:"Squid Proxy Configuration"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: ConfigMap\nmetadata:\n  name: squid-config\n  namespace: network-services\ndata:\n  squid.conf: |\n    acl allowed_domains dstdomain .github.com\n    acl allowed_domains dstdomain .googleapis.com\n    acl allowed_domains dstdomain .gcr.io\n    \n    http_access allow allowed_domains\n    http_access deny all\n    \n    access_log /var/log/squid/access.log\n    \n    http_port 3128\n"})}),"\n",(0,r.jsx)(n.h3,{id:"configure-pods-to-use-proxy",children:"Configure Pods to Use Proxy"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Pod\nmetadata:\n  name: app\nspec:\n  containers:\n    - name: app\n      image: myapp:latest\n      env:\n        - name: HTTP_PROXY\n          value: "http://egress-proxy.network-services:3128"\n        - name: HTTPS_PROXY\n          value: "http://egress-proxy.network-services:3128"\n        - name: NO_PROXY\n          value: ".cluster.local,.svc,10.0.0.0/8"\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"6-monitor-egress-traffic",children:"6. Monitor Egress Traffic"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," Without monitoring, unauthorized egress and data exfiltration go undetected.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Enable flow logging, monitor egress patterns, and alert on anomalies."]}),"\n",(0,r.jsx)(n.h3,{id:"cilium-hubble-observability",children:"Cilium Hubble Observability"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-bash",children:"cilium hubble enable\n\nhubble observe --type drop --protocol tcp --to-ip 0.0.0.0/0\n"})}),"\n",(0,r.jsx)(n.h3,{id:"alerting-on-suspicious-egress",children:"Alerting on Suspicious Egress"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",children:'groups:\n  - name: egress-security\n    rules:\n      - alert: UnauthorizedEgressAttempt\n        expr: |\n          sum(rate(cilium_drop_count_total{reason="Policy denied"}[5m])) by (namespace) > 10\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "High rate of denied egress in namespace {{ $labels.namespace }}"\n      \n      - alert: EgressToUnknownDestination\n        expr: |\n          sum(rate(network_bytes_total{direction="egress",destination!~"10\\\\..*"}[5m])) > 1000000\n        for: 10m\n        labels:\n          severity: warning\n        annotations:\n          summary: "Significant egress traffic to external destinations"\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"7-cloud-firewall-integration",children:"7. Cloud Firewall Integration"}),"\n",(0,r.jsxs)(n.p,{children:[(0,r.jsx)(n.strong,{children:"Issue:"})," Kubernetes NetworkPolicies alone may not prevent all egress if CNI enforcement is bypassed or misconfigured.",(0,r.jsx)("br",{}),"\n",(0,r.jsx)(n.strong,{children:"Fix:"})," Layer cloud-level firewall rules with Kubernetes policies for defense in depth."]}),"\n",(0,r.jsx)(n.h3,{id:"aws-security-group",children:"AWS Security Group"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-hcl",children:'resource "aws_security_group" "eks_worker_egress" {\n  name_prefix = "eks-worker-egress-"\n  vpc_id      = var.vpc_id\n\n  egress {\n    from_port   = 443\n    to_port     = 443\n    protocol    = "tcp"\n    cidr_blocks = ["203.0.113.0/24"]\n    description = "Payment gateway"\n  }\n\n  egress {\n    from_port   = 0\n    to_port     = 0\n    protocol    = "-1"\n    cidr_blocks = [var.vpc_cidr]\n    description = "Internal VPC"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"conclusion",children:"Conclusion"}),"\n",(0,r.jsx)(n.p,{children:"Egress control is critical for preventing compromised workloads from communicating with attackers, exfiltrating data, or abusing cloud services."}),"\n",(0,r.jsx)(n.p,{children:"Key takeaways:"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:["Implement ",(0,r.jsx)(n.strong,{children:"default-deny egress"})," policies"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Block cloud metadata"})," endpoints explicitly"]}),"\n",(0,r.jsxs)(n.li,{children:["Use ",(0,r.jsx)(n.strong,{children:"egress gateways"})," for centralized control"]}),"\n",(0,r.jsxs)(n.li,{children:["Consider ",(0,r.jsx)(n.strong,{children:"FQDN-based policies"})," for dynamic destinations"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Monitor egress"})," patterns and alert on anomalies"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.strong,{children:"Layer controls"})," with cloud firewalls for defense in depth"]}),"\n"]}),"\n",(0,r.jsx)(n.hr,{}),"\n",(0,r.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,r.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,r.jsxs)(n.ol,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/services-networking/network-policies/",children:"Network Policies"})," - Kubernetes Documentation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://docs.cilium.io/en/stable/security/policy/language/#dns-based",children:"Layer 3 Examples - DNS Based"})," - Cilium Documentation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://istio.io/latest/docs/tasks/traffic-management/egress/egress-gateway/",children:"Istio Egress Gateway"})," - Istio Documentation"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html",children:"Instance Metadata and User Data"})," - AWS Documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>o,x:()=>a});var t=s(6540);const r={},i=t.createContext(r);function o(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);