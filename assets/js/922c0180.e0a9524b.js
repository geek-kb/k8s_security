"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[6930],{2328(e,r,n){n.r(r),n.d(r,{assets:()=>l,contentTitle:()=>a,default:()=>d,frontMatter:()=>t,metadata:()=>i,toc:()=>c});const i=JSON.parse('{"id":"best-practices/cluster-setup-and-hardening/pod-security/security-profiles-operator","title":"Security Profiles Operator","description":"Learn how to use the Security Profiles Operator to manage seccomp, AppArmor, and SELinux profiles at scale in Kubernetes.","source":"@site/docs/best-practices/cluster-setup-and-hardening/pod-security/security-profiles-operator.md","sourceDirName":"best-practices/cluster-setup-and-hardening/pod-security","slug":"/best-practices/cluster-setup-and-hardening/pod-security/security-profiles-operator","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/pod-security/security-profiles-operator","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best-practices/cluster-setup-and-hardening/pod-security/security-profiles-operator.md","tags":[],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771236448000,"sidebarPosition":10,"frontMatter":{"title":"Security Profiles Operator","sidebar_position":10,"description":"Learn how to use the Security Profiles Operator to manage seccomp, AppArmor, and SELinux profiles at scale in Kubernetes.","keywords":["kubernetes security best practices","security profiles operator","seccomp","apparmor","selinux","profile management","security profiles","kubernetes security","pod security","CKS"]},"sidebar":"default","previous":{"title":"KubeAudit","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/pod-security/kubeaudit"},"next":{"title":"Securing Persistent Volumes","permalink":"/kubernetes-security/best-practices/cluster-setup-and-hardening/pod-security/persistent-volume-security"}}');var s=n(4848),o=n(8453);const t={title:"Security Profiles Operator",sidebar_position:10,description:"Learn how to use the Security Profiles Operator to manage seccomp, AppArmor, and SELinux profiles at scale in Kubernetes.",keywords:["kubernetes security best practices","security profiles operator","seccomp","apparmor","selinux","profile management","security profiles","kubernetes security","pod security","CKS"]},a="Security Profiles Operator",l={},c=[{value:"What is the Security Profiles Operator?",id:"what-is-the-security-profiles-operator",level:2},{value:"1. Install the Security Profiles Operator",id:"1-install-the-security-profiles-operator",level:2},{value:"Install via Manifest",id:"install-via-manifest",level:3},{value:"Install via Helm",id:"install-via-helm",level:3},{value:"Enable Log Enricher for Profile Recording",id:"enable-log-enricher-for-profile-recording",level:3},{value:"Enable eBPF Recorder for Advanced Recording",id:"enable-ebpf-recorder-for-advanced-recording",level:3},{value:"2. Create and Apply Seccomp Profiles",id:"2-create-and-apply-seccomp-profiles",level:2},{value:"Example: Create a Seccomp Profile",id:"example-create-a-seccomp-profile",level:3},{value:"Apply the Profile to a Pod",id:"apply-the-profile-to-a-pod",level:3},{value:"3. Record Seccomp Profiles from Running Workloads",id:"3-record-seccomp-profiles-from-running-workloads",level:2},{value:"Enable Recording for a Namespace",id:"enable-recording-for-a-namespace",level:3},{value:"Create a ProfileRecording",id:"create-a-profilerecording",level:3},{value:"Deploy the Workload to Record",id:"deploy-the-workload-to-record",level:3},{value:"Capture and Review the Profile",id:"capture-and-review-the-profile",level:3},{value:"4. Manage AppArmor Profiles",id:"4-manage-apparmor-profiles",level:2},{value:"Enable AppArmor Support",id:"enable-apparmor-support",level:3},{value:"Create an AppArmor Profile",id:"create-an-apparmor-profile",level:3},{value:"Apply the Profile to a Pod",id:"apply-the-profile-to-a-pod-1",level:3},{value:"5. Manage SELinux Profiles",id:"5-manage-selinux-profiles",level:2},{value:"Enable SELinux Support",id:"enable-selinux-support",level:3},{value:"Create a SELinux Profile",id:"create-a-selinux-profile",level:3},{value:"Wait for Profile Installation",id:"wait-for-profile-installation",level:3},{value:"Apply the Profile to a Pod",id:"apply-the-profile-to-a-pod-2",level:3},{value:"6. Use Base Profiles for Container Runtimes",id:"6-use-base-profiles-for-container-runtimes",level:2},{value:"Example: Extend the runc Base Profile",id:"example-extend-the-runc-base-profile",level:3},{value:"Use OCI Artifacts for Base Profiles",id:"use-oci-artifacts-for-base-profiles",level:3},{value:"7. Bind Profiles to Workloads Automatically",id:"7-bind-profiles-to-workloads-automatically",level:2},{value:"Enable Profile Binding",id:"enable-profile-binding",level:3},{value:"Create a ProfileBinding",id:"create-a-profilebinding",level:3},{value:"8. Monitor Profile Usage with Metrics",id:"8-monitor-profile-usage-with-metrics",level:2},{value:"Available Metrics",id:"available-metrics",level:3},{value:"Query Metrics",id:"query-metrics",level:3},{value:"9. Security Best Practices",id:"9-security-best-practices",level:2},{value:"Use Restrictive Default Actions",id:"use-restrictive-default-actions",level:3},{value:"Enable Profile Recording in Non-Production First",id:"enable-profile-recording-in-non-production-first",level:3},{value:"Restrict Allowed Syscalls",id:"restrict-allowed-syscalls",level:3},{value:"Use RBAC to Control Profile Management",id:"use-rbac-to-control-profile-management",level:3},{value:"Enable Memory Optimization for Large Clusters",id:"enable-memory-optimization-for-large-clusters",level:3},{value:"Security Checklist",id:"security-checklist",level:2},{value:"References",id:"references",level:2}];function p(e){const r={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,o.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"security-profiles-operator",children:"Security Profiles Operator"})}),"\n",(0,s.jsx)(r.p,{children:(0,s.jsx)(r.strong,{children:"Required knowledge for the CKS certification."})}),"\n",(0,s.jsx)(r.h2,{id:"what-is-the-security-profiles-operator",children:"What is the Security Profiles Operator?"}),"\n",(0,s.jsxs)(r.p,{children:["The ",(0,s.jsx)(r.strong,{children:"Security Profiles Operator (SPO)"})," is a ",(0,s.jsx)(r.strong,{children:"Kubernetes-native tool"})," developed by the ",(0,s.jsx)(r.strong,{children:"Kubernetes Security Special Interest Group (SIG Security)"})," that manages ",(0,s.jsx)(r.strong,{children:"seccomp, AppArmor, and SELinux profiles"})," at scale. It provides a unified approach to defining, recording, and applying security profiles across Kubernetes clusters."]}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Managing security profiles manually across multiple nodes is error-prone, time-consuming, and difficult to maintain as workloads scale.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," The Security Profiles Operator automates profile distribution, recording, and lifecycle management using Kubernetes Custom Resources."]}),"\n",(0,s.jsxs)(r.p,{children:["By using the Security Profiles Operator, you can ",(0,s.jsx)(r.strong,{children:"enforce security policies consistently"}),", ",(0,s.jsx)(r.strong,{children:"reduce manual configuration errors"}),", and ",(0,s.jsx)(r.strong,{children:"record profiles from running workloads"})," for baseline policy creation."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"1-install-the-security-profiles-operator",children:"1. Install the Security Profiles Operator"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Deploying security profiles manually requires creating files on each node and managing synchronization.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Install the Security Profiles Operator to centrally manage profiles as Kubernetes resources."]}),"\n",(0,s.jsx)(r.h3,{id:"install-via-manifest",children:"Install via Manifest"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"# Install cert-manager (required for webhook certificates)\nkubectl apply -f https://github.com/cert-manager/cert-manager/releases/download/v1.17.2/cert-manager.yaml\nkubectl --namespace cert-manager wait --for condition=ready pod -l app.kubernetes.io/instance=cert-manager\n\n# Install the Security Profiles Operator\nkubectl apply -f https://raw.githubusercontent.com/kubernetes-sigs/security-profiles-operator/main/deploy/operator.yaml\n\n# Verify installation\nkubectl -n security-profiles-operator get pods\n"})}),"\n",(0,s.jsx)(r.h3,{id:"install-via-helm",children:"Install via Helm"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"# Create namespace\nkubectl create ns security-profiles-operator\n\n# Label namespace for pod security\nkubectl label ns security-profiles-operator \\\n  pod-security.kubernetes.io/enforce=privileged \\\n  --overwrite=true\n\n# Download and install the Helm chart\nwget https://github.com/kubernetes-sigs/security-profiles-operator/releases/download/v0.10.0/security-profiles-operator-0.10.0.tgz\nhelm install security-profiles-operator \\\n  --namespace security-profiles-operator \\\n  ./security-profiles-operator-0.10.0.tgz\n"})}),"\n",(0,s.jsx)(r.h3,{id:"enable-log-enricher-for-profile-recording",children:"Enable Log Enricher for Profile Recording"}),"\n",(0,s.jsxs)(r.p,{children:["The ",(0,s.jsx)(r.strong,{children:"log enricher"})," enables recording profiles by analyzing audit logs."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type=merge \\\n  -p \'{"spec":{"enableLogEnricher":true}}\'\n'})}),"\n",(0,s.jsx)(r.h3,{id:"enable-ebpf-recorder-for-advanced-recording",children:"Enable eBPF Recorder for Advanced Recording"}),"\n",(0,s.jsxs)(r.p,{children:["The ",(0,s.jsx)(r.strong,{children:"eBPF recorder"})," provides more efficient profile recording without requiring audit logs."]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type=merge \\\n  -p \'{"spec":{"enableBpfRecorder":true}}\'\n'})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"2-create-and-apply-seccomp-profiles",children:"2. Create and Apply Seccomp Profiles"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Creating seccomp profiles requires understanding JSON syntax and manually distributing files to nodes.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Define seccomp profiles as Kubernetes Custom Resources that are automatically synchronized across nodes."]}),"\n",(0,s.jsx)(r.h3,{id:"example-create-a-seccomp-profile",children:"Example: Create a Seccomp Profile"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1beta1\nkind: SeccompProfile\nmetadata:\n  name: restricted-workload\n  namespace: production\nspec:\n  defaultAction: SCMP_ACT_ERRNO\n  architectures:\n    - SCMP_ARCH_X86_64\n  syscalls:\n    - action: SCMP_ACT_ALLOW\n      names:\n        - read\n        - write\n        - exit\n        - exit_group\n        - fstat\n        - openat\n        - close\n        - mmap\n        - mprotect\n        - brk\n"})}),"\n",(0,s.jsx)(r.p,{children:"Apply the profile:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl apply -f restricted-workload-seccomp.yaml\n\n# Verify profile status\nkubectl get seccompprofile -n production\n"})}),"\n",(0,s.jsx)(r.h3,{id:"apply-the-profile-to-a-pod",children:"Apply the Profile to a Pod"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: secure-app\n  namespace: production\nspec:\n  securityContext:\n    seccompProfile:\n      type: Localhost\n      localhostProfile: operator/production/restricted-workload.json\n  containers:\n    - name: app\n      image: nginx:1.21\n"})}),"\n",(0,s.jsxs)(r.p,{children:["The operator automatically creates the profile at ",(0,s.jsx)(r.code,{children:"/var/lib/kubelet/seccomp/operator/production/restricted-workload.json"})," on all nodes."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"3-record-seccomp-profiles-from-running-workloads",children:"3. Record Seccomp Profiles from Running Workloads"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Determining the exact syscalls required by an application is difficult without runtime analysis.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Use ProfileRecording to automatically capture syscalls from running containers."]}),"\n",(0,s.jsx)(r.h3,{id:"enable-recording-for-a-namespace",children:"Enable Recording for a Namespace"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl label ns production spo.x-k8s.io/enable-recording=\n"})}),"\n",(0,s.jsx)(r.h3,{id:"create-a-profilerecording",children:"Create a ProfileRecording"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1alpha1\nkind: ProfileRecording\nmetadata:\n  name: record-nginx\n  namespace: production\nspec:\n  kind: SeccompProfile\n  recorder: logs\n  podSelector:\n    matchLabels:\n      app: nginx\n"})}),"\n",(0,s.jsx)(r.h3,{id:"deploy-the-workload-to-record",children:"Deploy the Workload to Record"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-test\n  namespace: production\n  labels:\n    app: nginx\nspec:\n  containers:\n    - name: nginx\n      image: nginx:1.21\n"})}),"\n",(0,s.jsx)(r.h3,{id:"capture-and-review-the-profile",children:"Capture and Review the Profile"}),"\n",(0,s.jsx)(r.p,{children:"After running typical workload operations, delete the pod to finalize recording:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"# Allow workload to run and exercise all code paths\nkubectl exec -n production nginx-test -- curl http://localhost\n\n# Delete pod to trigger profile creation\nkubectl delete pod -n production nginx-test\n\n# View recorded profile\nkubectl get seccompprofile -n production\nkubectl get seccompprofile record-nginx-nginx -n production -o yaml\n"})}),"\n",(0,s.jsxs)(r.p,{children:["The operator creates a profile named ",(0,s.jsx)(r.code,{children:"record-nginx-nginx"})," containing all syscalls used during execution."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"4-manage-apparmor-profiles",children:"4. Manage AppArmor Profiles"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," AppArmor profiles require manual installation on each node and lack version control.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Define AppArmor profiles as Kubernetes resources managed by the operator."]}),"\n",(0,s.jsx)(r.h3,{id:"enable-apparmor-support",children:"Enable AppArmor Support"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type=merge \\\n  -p \'{"spec":{"enableAppArmor":true}}\'\n'})}),"\n",(0,s.jsx)(r.h3,{id:"create-an-apparmor-profile",children:"Create an AppArmor Profile"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1alpha1\nkind: ApparmorProfile\nmetadata:\n  name: nginx-apparmor\n  namespace: production\nspec:\n  profile: |\n    profile nginx-apparmor flags=(attach_disconnected,mediate_deleted) {\n      capability net_bind_service,\n      capability setgid,\n      capability setuid,\n      \n      network inet tcp,\n      network inet udp,\n      \n      /usr/sbin/nginx mr,\n      /var/log/nginx/** w,\n      /var/cache/nginx/** rw,\n      /etc/nginx/** r,\n      \n      deny /bin/bash rx,\n      deny /usr/bin/curl rx,\n      deny /usr/bin/wget rx,\n    }\n"})}),"\n",(0,s.jsx)(r.h3,{id:"apply-the-profile-to-a-pod-1",children:"Apply the Profile to a Pod"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-apparmor-pod\n  namespace: production\nspec:\n  containers:\n    - name: nginx\n      image: nginx:1.21\n      securityContext:\n        appArmorProfile:\n          type: Localhost\n          localhostProfile: nginx-apparmor\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"5-manage-selinux-profiles",children:"5. Manage SELinux Profiles"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," SELinux policies are complex to write and difficult to test without production workloads.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Use the operator to define, record, and apply SELinux profiles declaratively."]}),"\n",(0,s.jsx)(r.h3,{id:"enable-selinux-support",children:"Enable SELinux Support"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type=merge \\\n  -p \'{"spec":{"enableSelinux":true}}\'\n'})}),"\n",(0,s.jsx)(r.h3,{id:"create-a-selinux-profile",children:"Create a SELinux Profile"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'apiVersion: security-profiles-operator.x-k8s.io/v1alpha2\nkind: SelinuxProfile\nmetadata:\n  name: nginx-selinux\n  namespace: production\nspec:\n  allow:\n    "@self":\n      tcp_socket:\n        - listen\n        - accept\n        - bind\n    http_port_t:\n      tcp_socket:\n        - name_bind\n    http_cache_port_t:\n      tcp_socket:\n        - name_bind\n    node_t:\n      tcp_socket:\n        - node_bind\n  inherit:\n    - kind: System\n      name: container\n'})}),"\n",(0,s.jsx)(r.h3,{id:"wait-for-profile-installation",children:"Wait for Profile Installation"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl wait --for=condition=ready selinuxprofile nginx-selinux -n production\n"})}),"\n",(0,s.jsx)(r.h3,{id:"apply-the-profile-to-a-pod-2",children:"Apply the Profile to a Pod"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: nginx-selinux-pod\n  namespace: production\nspec:\n  containers:\n    - name: nginx\n      image: nginxinc/nginx-unprivileged:1.21\n      securityContext:\n        seLinuxOptions:\n          type: nginx-selinux.process\n"})}),"\n",(0,s.jsxs)(r.p,{children:["The SELinux type follows the format ",(0,s.jsx)(r.code,{children:"<ProfileName>.process"}),"."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"6-use-base-profiles-for-container-runtimes",children:"6. Use Base Profiles for Container Runtimes"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Container runtimes require specific syscalls to function, but manually determining them is time-consuming.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Reference base profiles for common runtimes to ensure compatibility."]}),"\n",(0,s.jsx)(r.h3,{id:"example-extend-the-runc-base-profile",children:"Example: Extend the runc Base Profile"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1beta1\nkind: SeccompProfile\nmetadata:\n  name: app-with-network\n  namespace: production\nspec:\n  defaultAction: SCMP_ACT_ERRNO\n  baseProfileName: runc-v1.4.0\n  syscalls:\n    - action: SCMP_ACT_ALLOW\n      names:\n        - socket\n        - connect\n        - sendto\n        - recvfrom\n"})}),"\n",(0,s.jsxs)(r.p,{children:["This profile inherits all syscalls from ",(0,s.jsx)(r.code,{children:"runc-v1.4.0"})," and adds networking syscalls."]}),"\n",(0,s.jsx)(r.h3,{id:"use-oci-artifacts-for-base-profiles",children:"Use OCI Artifacts for Base Profiles"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1beta1\nkind: SeccompProfile\nmetadata:\n  name: app-with-oci-base\n  namespace: production\nspec:\n  defaultAction: SCMP_ACT_ERRNO\n  baseProfileName: oci://ghcr.io/security-profiles/runc:v1.4.0\n  syscalls:\n    - action: SCMP_ACT_ALLOW\n      names:\n        - socket\n"})}),"\n",(0,s.jsx)(r.p,{children:"The operator automatically pulls and verifies signed base profiles from OCI registries."}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"7-bind-profiles-to-workloads-automatically",children:"7. Bind Profiles to Workloads Automatically"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Modifying existing workload manifests to add security profiles is disruptive.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Use ProfileBinding to automatically apply profiles based on image matching."]}),"\n",(0,s.jsx)(r.h3,{id:"enable-profile-binding",children:"Enable Profile Binding"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"kubectl label ns production spo.x-k8s.io/enable-binding=\n"})}),"\n",(0,s.jsx)(r.h3,{id:"create-a-profilebinding",children:"Create a ProfileBinding"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"apiVersion: security-profiles-operator.x-k8s.io/v1alpha1\nkind: ProfileBinding\nmetadata:\n  name: nginx-binding\n  namespace: production\nspec:\n  profileRef:\n    kind: SeccompProfile\n    name: restricted-workload\n  image: nginx:1.21\n"})}),"\n",(0,s.jsxs)(r.p,{children:["All pods in the ",(0,s.jsx)(r.code,{children:"production"})," namespace using the ",(0,s.jsx)(r.code,{children:"nginx:1.21"})," image will automatically have the ",(0,s.jsx)(r.code,{children:"restricted-workload"})," seccomp profile applied."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"8-monitor-profile-usage-with-metrics",children:"8. Monitor Profile Usage with Metrics"}),"\n",(0,s.jsxs)(r.p,{children:[(0,s.jsx)(r.strong,{children:"Issue:"})," Without visibility into profile enforcement, detecting policy violations and tuning profiles is difficult.",(0,s.jsx)("br",{}),"\n",(0,s.jsx)(r.strong,{children:"Fix:"})," Use the operator's Prometheus metrics to monitor profile operations."]}),"\n",(0,s.jsx)(r.h3,{id:"available-metrics",children:"Available Metrics"}),"\n",(0,s.jsxs)(r.p,{children:["The operator exposes metrics at ",(0,s.jsx)(r.code,{children:"https://metrics.security-profiles-operator/metrics-spod"}),":"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"security_profiles_operator_seccomp_profile_total"})," - Total seccomp profile operations"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"security_profiles_operator_seccomp_profile_audit_total"})," - Seccomp audit events"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"security_profiles_operator_seccomp_profile_error_total"})," - Seccomp profile errors"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"security_profiles_operator_selinux_profile_total"})," - Total SELinux profile operations"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.code,{children:"security_profiles_operator_selinux_profile_audit_total"})," - SELinux audit events"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"query-metrics",children:"Query Metrics"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"# Create a pod to query metrics\nkubectl run metrics-client --rm -i --restart=Never \\\n  --image=registry.fedoraproject.org/fedora-minimal:latest \\\n  -n security-profiles-operator -- bash -c \\\n  'curl -ks -H \"Authorization: Bearer $(cat /var/run/secrets/kubernetes.io/serviceaccount/token)\" \\\n   https://metrics.security-profiles-operator/metrics-spod | grep security_profiles_operator'\n"})}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"9-security-best-practices",children:"9. Security Best Practices"}),"\n",(0,s.jsx)(r.h3,{id:"use-restrictive-default-actions",children:"Use Restrictive Default Actions"}),"\n",(0,s.jsxs)(r.p,{children:["Always set ",(0,s.jsx)(r.code,{children:"defaultAction: SCMP_ACT_ERRNO"})," for seccomp profiles to deny all syscalls by default:"]}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"spec:\n  defaultAction: SCMP_ACT_ERRNO\n  syscalls:\n    - action: SCMP_ACT_ALLOW\n      names:\n        - read\n        - write\n"})}),"\n",(0,s.jsx)(r.h3,{id:"enable-profile-recording-in-non-production-first",children:"Enable Profile Recording in Non-Production First"}),"\n",(0,s.jsx)(r.p,{children:"Record profiles in development or staging environments before applying them to production:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:"# Label development namespace for recording\nkubectl label ns dev spo.x-k8s.io/enable-recording=\n\n# Deploy ProfileRecording in dev\nkubectl apply -f profile-recording.yaml -n dev\n"})}),"\n",(0,s.jsx)(r.h3,{id:"restrict-allowed-syscalls",children:"Restrict Allowed Syscalls"}),"\n",(0,s.jsx)(r.p,{children:"Configure the operator to reject profiles containing dangerous syscalls:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type merge \\\n  -p \'{"spec":{"allowedSyscalls": ["read", "write", "exit", "exit_group", "fstat", "openat", "close"]}}\'\n'})}),"\n",(0,s.jsx)(r.h3,{id:"use-rbac-to-control-profile-management",children:"Use RBAC to Control Profile Management"}),"\n",(0,s.jsx)(r.p,{children:"Create roles that limit who can create or modify security profiles:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: seccomp-profile-editor\n  namespace: production\nrules:\n  - apiGroups: ["security-profiles-operator.x-k8s.io"]\n    resources: ["seccompprofiles"]\n    verbs: ["get", "list", "watch", "create", "update", "patch"]\n'})}),"\n",(0,s.jsx)(r.h3,{id:"enable-memory-optimization-for-large-clusters",children:"Enable Memory Optimization for Large Clusters"}),"\n",(0,s.jsx)(r.p,{children:"In clusters with thousands of pods, enable memory optimization:"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-bash",children:'kubectl -n security-profiles-operator patch spod spod --type=merge \\\n  -p \'{"spec":{"enableMemoryOptimization":true}}\'\n'})}),"\n",(0,s.jsxs)(r.p,{children:["When enabled, only pods labeled with ",(0,s.jsx)(r.code,{children:"spo.x-k8s.io/enable-recording=true"})," are tracked."]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"security-checklist",children:"Security Checklist"}),"\n",(0,s.jsxs)(r.ul,{className:"contains-task-list",children:["\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Install the Security Profiles Operator using signed releases"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Enable log enricher or eBPF recorder for profile recording"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Record profiles from running workloads in non-production environments"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Use restrictive default actions in seccomp profiles"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Apply profiles to pods via ProfileBinding for automation"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Monitor profile metrics for audit events and errors"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Restrict allowed syscalls at the operator level for high-security clusters"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Use RBAC to control who can create and modify security profiles"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Test profiles thoroughly before applying to production workloads"]}),"\n",(0,s.jsxs)(r.li,{className:"task-list-item",children:[(0,s.jsx)(r.input,{type:"checkbox",disabled:!0})," ","Use base profiles from trusted OCI registries"]}),"\n"]}),"\n",(0,s.jsx)(r.hr,{}),"\n",(0,s.jsx)(r.h2,{id:"references",children:"References"}),"\n",(0,s.jsx)(r.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://github.com/kubernetes-sigs/security-profiles-operator",children:"Security Profiles Operator"})," - Kubernetes SIG Security GitHub Repository"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://kubernetes.io/docs/tutorials/security/seccomp/",children:"Restrict a Container's Syscalls with seccomp"})," - Kubernetes Documentation"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://kubernetes.io/docs/tutorials/security/apparmor/",children:"Restrict a Container's Access to Resources with AppArmor"})," - Kubernetes Documentation"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.a,{href:"https://github.com/kubernetes-sigs/security-profiles-operator/blob/main/installation-usage.md",children:"Security Profiles Operator Installation Guide"})," - Kubernetes SIG Security Documentation"]}),"\n"]})]})}function d(e={}){const{wrapper:r}={...(0,o.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(p,{...e})}):p(e)}},8453(e,r,n){n.d(r,{R:()=>t,x:()=>a});var i=n(6540);const s={},o=i.createContext(s);function t(e){const r=i.useContext(o);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(o.Provider,{value:r},e.children)}}}]);