"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[7142],{1544(e,n,s){s.r(n),s.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>c});const a=JSON.parse('{"id":"best_practices/cluster_setup_and_hardening/node_security/changed_block_tracking","title":"Changed Block Tracking for Volume Snapshots","description":"Optimize backup and disaster recovery with Kubernetes v1.34 Changed Block Tracking API for efficient incremental volume snapshots.","source":"@site/docs/best_practices/cluster_setup_and_hardening/node_security/changed_block_tracking.md","sourceDirName":"best_practices/cluster_setup_and_hardening/node_security","slug":"/best_practices/cluster_setup_and_hardening/node_security/changed_block_tracking","permalink":"/docs/best_practices/cluster_setup_and_hardening/node_security/changed_block_tracking","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best_practices/cluster_setup_and_hardening/node_security/changed_block_tracking.md","tags":[],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1770102262000,"sidebarPosition":7,"frontMatter":{"title":"Changed Block Tracking for Volume Snapshots","description":"Optimize backup and disaster recovery with Kubernetes v1.34 Changed Block Tracking API for efficient incremental volume snapshots.","sidebar_position":7,"keywords":["kubernetes security","changed block tracking","volume snapshots","backup and recovery","incremental backups","CSI driver","disaster recovery","storage security","CKS"]},"sidebar":"default","previous":{"title":"Kubelet Security Overview","permalink":"/docs/best_practices/cluster_setup_and_hardening/node_security/kubelet_security"},"next":{"title":"Securing Kubelet Authentication and Authorization","permalink":"/docs/best_practices/cluster_setup_and_hardening/node_security/kubelet_authentication"}}');var t=s(4848),r=s(8453);const i={title:"Changed Block Tracking for Volume Snapshots",description:"Optimize backup and disaster recovery with Kubernetes v1.34 Changed Block Tracking API for efficient incremental volume snapshots.",sidebar_position:7,keywords:["kubernetes security","changed block tracking","volume snapshots","backup and recovery","incremental backups","CSI driver","disaster recovery","storage security","CKS"]},o="Changed Block Tracking for Volume Snapshots",l={},c=[{value:"1. Understanding Changed Block Tracking",id:"1-understanding-changed-block-tracking",level:2},{value:"Security Benefits",id:"security-benefits",level:3},{value:"2. How Changed Block Tracking Works",id:"2-how-changed-block-tracking-works",level:2},{value:"Architecture",id:"architecture",level:3},{value:"3. Enabling Changed Block Tracking",id:"3-enabling-changed-block-tracking",level:2},{value:"Prerequisites",id:"prerequisites",level:3},{value:"Example: Enable CBT Feature Gate",id:"example-enable-cbt-feature-gate",level:3},{value:"4. Creating Snapshots with CBT",id:"4-creating-snapshots-with-cbt",level:2},{value:"Example: PersistentVolumeClaim with CBT-Compatible Storage",id:"example-persistentvolumeclaim-with-cbt-compatible-storage",level:3},{value:"Example: VolumeSnapshotClass with CBT Enabled",id:"example-volumesnapshotclass-with-cbt-enabled",level:3},{value:"Example: Create Initial Snapshot",id:"example-create-initial-snapshot",level:3},{value:"Example: Create Incremental Snapshot",id:"example-create-incremental-snapshot",level:3},{value:"5. Querying Changed Blocks",id:"5-querying-changed-blocks",level:2},{value:"Example: Query Changed Blocks Between Snapshots",id:"example-query-changed-blocks-between-snapshots",level:3},{value:"Check Delta Query Status",id:"check-delta-query-status",level:3},{value:"6. Security Considerations",id:"6-security-considerations",level:2},{value:"Example: RBAC for CBT Operations",id:"example-rbac-for-cbt-operations",level:3},{value:"Restrict CBT Access to Backup Tools Only",id:"restrict-cbt-access-to-backup-tools-only",level:3},{value:"7. Integration with Backup Tools",id:"7-integration-with-backup-tools",level:2},{value:"Velero Integration Example",id:"velero-integration-example",level:3},{value:"Custom Backup Script with CBT",id:"custom-backup-script-with-cbt",level:3},{value:"8. Monitoring and Alerting",id:"8-monitoring-and-alerting",level:2},{value:"Prometheus Metrics to Monitor",id:"prometheus-metrics-to-monitor",level:3},{value:"Example PrometheusRule for CBT Alerts",id:"example-prometheusrule-for-cbt-alerts",level:3},{value:"9. Best Practices for CBT",id:"9-best-practices-for-cbt",level:2},{value:"10. Security Checklist",id:"10-security-checklist",level:2},{value:"11. Limitations and Considerations",id:"11-limitations-and-considerations",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"changed-block-tracking-for-volume-snapshots",children:"Changed Block Tracking for Volume Snapshots"})}),"\n",(0,t.jsxs)(n.p,{children:["As of ",(0,t.jsx)(n.strong,{children:"Kubernetes v1.34"}),", the ",(0,t.jsx)(n.strong,{children:"Changed Block Tracking (CBT) API"})," is available in ",(0,t.jsx)(n.strong,{children:"alpha"})," status. This feature enhances the storage ecosystem by providing an efficient mechanism for CSI storage drivers to identify changed blocks in PersistentVolume snapshots, enabling faster incremental backups and disaster recovery operations."]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," Traditional full-volume snapshots are inefficient for large volumes, consuming excessive storage space and time, making frequent backups impractical.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.strong,{children:"Fix:"})," Changed Block Tracking API enables CSI drivers to identify only the blocks that have changed since the last snapshot, dramatically reducing backup time and storage requirements."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"1-understanding-changed-block-tracking",children:"1. Understanding Changed Block Tracking"}),"\n",(0,t.jsx)(n.p,{children:"Changed Block Tracking is a storage optimization technique that records which blocks of a volume have been modified since a previous snapshot. This information enables:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Incremental Backups"})," - Copy only changed data instead of entire volumes"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Faster Disaster Recovery"})," - Restore only modified blocks"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reduced Storage Costs"})," - Store smaller differential snapshots"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Improved RPO/RTO"})," - More frequent backups with less impact"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"security-benefits",children:"Security Benefits"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Ransomware Detection"})," - Unusual block change patterns can indicate encryption attacks"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Compliance"})," - Efficient backup windows enable more frequent snapshots for audit trails"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Data Integrity"})," - Faster verification of backup consistency"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Reduced Attack Surface"})," - Shorter backup windows mean less exposure time"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"2-how-changed-block-tracking-works",children:"2. How Changed Block Tracking Works"}),"\n",(0,t.jsx)(n.p,{children:"The CBT API introduces new resources and operations:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"VolumeSnapshotDelta"})," - Represents the differences between two snapshots"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Changed Block Query"})," - CSI driver API to retrieve changed block ranges"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Block Range Metadata"})," - Information about which blocks have changed"]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"architecture",children:"Architecture"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    Kubernetes API Server                    \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u2502 CBT API Requests\n                             \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    CSI Driver (with CBT)                    \u2502\n\u2502  \u2022 Tracks block changes                                     \u2502\n\u2502  \u2022 Maintains change bitmaps                                 \u2502\n\u2502  \u2022 Provides delta information                               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                             \u2502\n                             \u2502 Storage Backend Communication\n                             \u2502\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              Storage Backend (e.g., Ceph, NFS)              \u2502\n\u2502  \u2022 Stores actual volume data                                \u2502\n\u2502  \u2022 Maintains snapshots                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"3-enabling-changed-block-tracking",children:"3. Enabling Changed Block Tracking"}),"\n",(0,t.jsx)(n.h3,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"Kubernetes v1.34 or later"}),"\n",(0,t.jsx)(n.li,{children:"CSI driver with CBT support (driver-specific)"}),"\n",(0,t.jsxs)(n.li,{children:["Feature gate enabled: ",(0,t.jsx)(n.code,{children:"VolumeSnapshotDelta=true"})]}),"\n"]}),"\n",(0,t.jsx)(n.h3,{id:"example-enable-cbt-feature-gate",children:"Example: Enable CBT Feature Gate"}),"\n",(0,t.jsx)(n.p,{children:"For clusters using kubeadm, add to the API server configuration:"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: kubeadm.k8s.io/v1beta4\nkind: ClusterConfiguration\napiServer:\n  extraArgs:\n    feature-gates: "VolumeSnapshotDelta=true"\ncontrollerManager:\n  extraArgs:\n    feature-gates: "VolumeSnapshotDelta=true"\n'})}),"\n",(0,t.jsx)(n.p,{children:"For managed Kubernetes (EKS, GKE, AKS), consult provider documentation for alpha feature enablement."}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"4-creating-snapshots-with-cbt",children:"4. Creating Snapshots with CBT"}),"\n",(0,t.jsx)(n.h3,{id:"example-persistentvolumeclaim-with-cbt-compatible-storage",children:"Example: PersistentVolumeClaim with CBT-Compatible Storage"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: PersistentVolumeClaim\nmetadata:\n  name: database-pvc\n  namespace: production\nspec:\n  accessModes:\n    - ReadWriteOnce\n  resources:\n    requests:\n      storage: 100Gi\n  storageClassName: cbt-enabled-storage\n"})}),"\n",(0,t.jsx)(n.h3,{id:"example-volumesnapshotclass-with-cbt-enabled",children:"Example: VolumeSnapshotClass with CBT Enabled"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshotClass\nmetadata:\n  name: cbt-snapshot-class\ndriver: csi.example.com\ndeletionPolicy: Retain\nparameters:\n  enableChangedBlockTracking: "true"\n  snapshotType: "incremental"\n'})}),"\n",(0,t.jsx)(n.h3,{id:"example-create-initial-snapshot",children:"Example: Create Initial Snapshot"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshot\nmetadata:\n  name: database-snapshot-baseline\n  namespace: production\nspec:\n  volumeSnapshotClassName: cbt-snapshot-class\n  source:\n    persistentVolumeClaimName: database-pvc\n"})}),"\n",(0,t.jsx)(n.h3,{id:"example-create-incremental-snapshot",children:"Example: Create Incremental Snapshot"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshot\nmetadata:\n  name: database-snapshot-incremental-1\n  namespace: production\nspec:\n  volumeSnapshotClassName: cbt-snapshot-class\n  source:\n    persistentVolumeClaimName: database-pvc\n  # Reference to previous snapshot for delta tracking\n  sourceSnapshotName: database-snapshot-baseline\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"5-querying-changed-blocks",children:"5. Querying Changed Blocks"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," Backup tools need efficient access to changed block information without reading entire volumes.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.strong,{children:"Fix:"})," Use the VolumeSnapshotDelta API to query only changed blocks."]}),"\n",(0,t.jsx)(n.h3,{id:"example-query-changed-blocks-between-snapshots",children:"Example: Query Changed Blocks Between Snapshots"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: snapshot.storage.k8s.io/v1alpha1\nkind: VolumeSnapshotDelta\nmetadata:\n  name: database-delta-query\n  namespace: production\nspec:\n  sourceSnapshot: database-snapshot-baseline\n  targetSnapshot: database-snapshot-incremental-1\n"})}),"\n",(0,t.jsx)(n.h3,{id:"check-delta-query-status",children:"Check Delta Query Status"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:"kubectl get volumesnapshotdelta database-delta-query -n production -o yaml\n"})}),"\n",(0,t.jsx)(n.p,{children:(0,t.jsx)(n.strong,{children:"Example Output:"})}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: snapshot.storage.k8s.io/v1alpha1\nkind: VolumeSnapshotDelta\nmetadata:\n  name: database-delta-query\n  namespace: production\nstatus:\n  changedBlocks:\n    - startOffset: 1048576 # 1 MB\n      length: 524288 # 512 KB\n    - startOffset: 104857600 # 100 MB\n      length: 1048576 # 1 MB\n  totalChangedBytes: 1572864\n  snapshotSizeBytes: 107374182400 # 100 GB\n  percentageChanged: 0.00146\n"})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"6-security-considerations",children:"6. Security Considerations"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," Changed block information could reveal sensitive patterns about data modifications and application behavior.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.strong,{children:"Fix:"})," Implement RBAC controls and encryption for CBT metadata and operations."]}),"\n",(0,t.jsx)(n.h3,{id:"example-rbac-for-cbt-operations",children:"Example: RBAC for CBT Operations"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: Role\nmetadata:\n  name: snapshot-operator\n  namespace: production\nrules:\n  - apiGroups: ["snapshot.storage.k8s.io"]\n    resources: ["volumesnapshots", "volumesnapshotdelta"]\n    verbs: ["get", "list", "create", "delete"]\n  - apiGroups: ["snapshot.storage.k8s.io"]\n    resources: ["volumesnapshotclasses"]\n    verbs: ["get", "list"]\n  - apiGroups: [""]\n    resources: ["persistentvolumeclaims"]\n    verbs: ["get", "list"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: RoleBinding\nmetadata:\n  name: backup-operator-binding\n  namespace: production\nsubjects:\n  - kind: ServiceAccount\n    name: backup-operator\n    namespace: production\nroleRef:\n  kind: Role\n  name: snapshot-operator\n  apiGroup: rbac.authorization.k8s.io\n'})}),"\n",(0,t.jsx)(n.h3,{id:"restrict-cbt-access-to-backup-tools-only",children:"Restrict CBT Access to Backup Tools Only"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: cbt-admin\nrules:\n  - apiGroups: ["snapshot.storage.k8s.io"]\n    resources: ["volumesnapshotdelta"]\n    verbs: ["*"]\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: velero-cbt-access\nsubjects:\n  - kind: ServiceAccount\n    name: velero\n    namespace: velero\nroleRef:\n  kind: ClusterRole\n  name: cbt-admin\n  apiGroup: rbac.authorization.k8s.io\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"7-integration-with-backup-tools",children:"7. Integration with Backup Tools"}),"\n",(0,t.jsx)(n.h3,{id:"velero-integration-example",children:"Velero Integration Example"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," Traditional Velero backups copy entire volumes even when minimal data has changed.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.strong,{children:"Fix:"})," Use CBT-aware Velero plugins for incremental volume backups."]}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:"apiVersion: velero.io/v1\nkind: Backup\nmetadata:\n  name: production-incremental\n  namespace: velero\nspec:\n  includedNamespaces:\n    - production\n  snapshotVolumes: true\n  volumeSnapshotLocations:\n    - cbt-enabled-location\n  csiSnapshotTimeout: 10m\n  # Enable CBT for incremental snapshots\n  hooks:\n    resources:\n      - name: use-changed-block-tracking\n        includedNamespaces:\n          - production\n        labelSelector:\n          matchLabels:\n            backup-method: incremental\n"})}),"\n",(0,t.jsx)(n.h3,{id:"custom-backup-script-with-cbt",children:"Custom Backup Script with CBT"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-bash",children:'#!/bin/bash\n# Incremental backup script using CBT API\n\nNAMESPACE="production"\nPVC_NAME="database-pvc"\nBASELINE_SNAPSHOT="database-snapshot-baseline"\nNEW_SNAPSHOT="database-snapshot-$(date +%Y%m%d-%H%M%S)"\n\n# Create new snapshot\nkubectl create -f - <<EOF\napiVersion: snapshot.storage.k8s.io/v1\nkind: VolumeSnapshot\nmetadata:\n  name: ${NEW_SNAPSHOT}\n  namespace: ${NAMESPACE}\nspec:\n  volumeSnapshotClassName: cbt-snapshot-class\n  source:\n    persistentVolumeClaimName: ${PVC_NAME}\n  sourceSnapshotName: ${BASELINE_SNAPSHOT}\nEOF\n\n# Wait for snapshot to be ready\nkubectl wait --for=condition=ReadyToUse \\\n  volumesnapshot/${NEW_SNAPSHOT} \\\n  -n ${NAMESPACE} \\\n  --timeout=300s\n\n# Query changed blocks\nkubectl create -f - <<EOF\napiVersion: snapshot.storage.k8s.io/v1alpha1\nkind: VolumeSnapshotDelta\nmetadata:\n  name: ${NEW_SNAPSHOT}-delta\n  namespace: ${NAMESPACE}\nspec:\n  sourceSnapshot: ${BASELINE_SNAPSHOT}\n  targetSnapshot: ${NEW_SNAPSHOT}\nEOF\n\n# Extract and backup only changed blocks\nkubectl get volumesnapshotdelta ${NEW_SNAPSHOT}-delta \\\n  -n ${NAMESPACE} \\\n  -o jsonpath=\'{.status.changedBlocks}\' | \\\n  jq -r \'.[] | "\\(.startOffset) \\(.length)"\' | \\\n  while read offset length; do\n    echo "Backing up changed block: offset=$offset length=$length"\n    # Custom logic to extract and backup changed blocks\n  done\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"8-monitoring-and-alerting",children:"8. Monitoring and Alerting"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Issue:"})," CBT operations can fail silently, leading to incomplete backups and data loss risks.",(0,t.jsx)("br",{}),"\n",(0,t.jsx)(n.strong,{children:"Fix:"})," Implement monitoring and alerting for CBT operations and snapshot health."]}),"\n",(0,t.jsx)(n.h3,{id:"prometheus-metrics-to-monitor",children:"Prometheus Metrics to Monitor"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-promql",children:"# Failed snapshot operations\nrate(volume_snapshot_failures_total[5m]) > 0\n\n# CBT query duration\nhistogram_quantile(0.99, rate(cbt_query_duration_seconds_bucket[5m])) > 30\n\n# Changed block percentage (detect ransomware)\ncbt_changed_blocks_percentage > 50\n\n# Snapshot age (detect stale backups)\ntime() - volume_snapshot_creation_timestamp_seconds > 86400\n"})}),"\n",(0,t.jsx)(n.h3,{id:"example-prometheusrule-for-cbt-alerts",children:"Example PrometheusRule for CBT Alerts"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-yaml",children:'apiVersion: monitoring.coreos.com/v1\nkind: PrometheusRule\nmetadata:\n  name: cbt-alerts\n  namespace: monitoring\nspec:\n  groups:\n    - name: changed-block-tracking\n      interval: 30s\n      rules:\n        - alert: CBTQueryFailed\n          expr: cbt_query_failures_total > 0\n          for: 5m\n          labels:\n            severity: warning\n          annotations:\n            summary: "Changed Block Tracking query failed"\n            description: "CBT query for {{ $labels.namespace }}/{{ $labels.snapshot }} has failed"\n\n        - alert: UnusualBlockChangeRate\n          expr: cbt_changed_blocks_percentage > 70\n          for: 10m\n          labels:\n            severity: critical\n          annotations:\n            summary: "Unusual percentage of blocks changed (possible ransomware)"\n            description: "Volume {{ $labels.pvc }} shows {{ $value }}% blocks changed, investigate immediately"\n\n        - alert: SnapshotStale\n          expr: (time() - volume_snapshot_creation_timestamp_seconds) / 3600 > 24\n          for: 1h\n          labels:\n            severity: warning\n          annotations:\n            summary: "Volume snapshot is over 24 hours old"\n            description: "Snapshot {{ $labels.snapshot }} in {{ $labels.namespace }} has not been updated"\n'})}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"9-best-practices-for-cbt",children:"9. Best Practices for CBT"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Enable only on supported CSI drivers"})," - Verify driver CBT capabilities before enabling"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Use incremental snapshots for large volumes"})," - CBT is most beneficial for volumes >100GB"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Implement RBAC restrictions"})," - Limit CBT query access to backup tools only"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Monitor change patterns"})," - Alert on unusual block change rates (ransomware detection)"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Test restore procedures"})," - Regularly validate incremental backup restores"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Retain baseline snapshots"})," - Keep full snapshots for recovery validation"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Implement snapshot retention policies"})," - Automate cleanup of old snapshots"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Encrypt snapshot data"})," - Use storage backend encryption for snapshot security"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Document snapshot dependencies"})," - Track which incremental snapshots depend on baselines"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"Monitor CBT performance"})," - Track query latency and optimize as needed"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"10-security-checklist",children:"10. Security Checklist"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:"\u2705 CBT feature gate enabled only in controlled environments (alpha feature)"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 RBAC policies restrict VolumeSnapshotDelta access to backup operators"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Snapshot encryption enabled at storage backend level"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Monitoring and alerting configured for CBT operations"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Unusual block change rate alerts configured for ransomware detection"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Baseline snapshots protected from accidental deletion"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Backup and restore procedures tested regularly"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Snapshot retention policies automated and audited"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Access logs enabled for snapshot and CBT operations"}),"\n",(0,t.jsx)(n.li,{children:"\u2705 Documentation maintained for CBT-enabled volumes and dependencies"}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"11-limitations-and-considerations",children:"11. Limitations and Considerations"}),"\n",(0,t.jsx)(n.p,{children:"As an alpha feature in Kubernetes v1.34, Changed Block Tracking has important limitations:"}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"CSI Driver Support"})," - Limited to CSI drivers that implement CBT (check driver documentation)"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Performance Overhead"})," - Block tracking adds small overhead to I/O operations"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Storage Backend Requirements"})," - Underlying storage must support efficient delta tracking"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"API Stability"})," - Alpha API may change in future Kubernetes versions"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Limited Tooling"})," - Backup tools are still adding CBT support"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"Documentation"})," - Vendor-specific implementation details may vary"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"Recommendation:"})," Test thoroughly in non-production environments before enabling in production clusters."]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,t.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://kubernetes.io/docs/concepts/storage/volume-snapshots/",children:"Volume Snapshots"})," - Kubernetes Documentation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://kubernetes-csi.github.io/docs/",children:"CSI Driver Documentation"})," - Kubernetes CSI Developer Documentation"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://github.com/kubernetes/enhancements/tree/master/keps/sig-storage",children:"Kubernetes Enhancement Proposals - sig-storage"})," - Kubernetes GitHub"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.a,{href:"https://velero.io/docs/",children:"Velero Documentation"})," - Velero Project"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(d,{...e})}):d(e)}},8453(e,n,s){s.d(n,{R:()=>i,x:()=>o});var a=s(6540);const t={},r=a.createContext(t);function i(e){const n=a.useContext(r);return a.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:i(e.components),a.createElement(r.Provider,{value:n},e.children)}}}]);