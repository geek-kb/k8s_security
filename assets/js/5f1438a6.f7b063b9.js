"use strict";(globalThis.webpackChunkk_8_s_security=globalThis.webpackChunkk_8_s_security||[]).push([[7689],{5605(e,n,t){t.r(n),t.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>i,metadata:()=>r,toc:()=>l});const r=JSON.parse('{"id":"best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam","title":"kiam","description":"kiam provides AWS IAM credentials to pods running on Kubernetes, using a client-server architecture for improved security over metadata interception.","source":"@site/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam.md","sourceDirName":"best_practices/cluster_setup_and_hardening/rbac_and_identity","slug":"/best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam","draft":false,"unlisted":false,"editUrl":"https://github.com/geek-kb/k8s_security/edit/main/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kiam.md","tags":[{"inline":true,"label":"tool","permalink":"/docs/tags/tool"},{"inline":true,"label":"rbac","permalink":"/docs/tags/rbac"},{"inline":true,"label":"cloud-security","permalink":"/docs/tags/cloud-security"},{"inline":true,"label":"AWS","permalink":"/docs/tags/aws"}],"version":"current","lastUpdatedBy":"Itai Ganot","lastUpdatedAt":1771232119000,"sidebarPosition":21,"frontMatter":{"sidebar_position":21,"title":"kiam","description":"kiam provides AWS IAM credentials to pods running on Kubernetes, using a client-server architecture for improved security over metadata interception.","keywords":["kubernetes security tool","kiam","AWS IAM","pod identity","kubernetes AWS integration","IAM roles for pods","credential management","cloud security","CKS"],"tags":["tool","rbac","cloud-security","AWS"],"related":["/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kube2iam/","/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/attack_vectors/cloud_metadata_service_abuse/"]},"sidebar":"default","previous":{"title":"kube2iam","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kube2iam"},"next":{"title":"aad-pod-identity","permalink":"/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/aad_pod_identity"}}');var s=t(4848),a=t(8453);const i={sidebar_position:21,title:"kiam",description:"kiam provides AWS IAM credentials to pods running on Kubernetes, using a client-server architecture for improved security over metadata interception.",keywords:["kubernetes security tool","kiam","AWS IAM","pod identity","kubernetes AWS integration","IAM roles for pods","credential management","cloud security","CKS"],tags:["tool","rbac","cloud-security","AWS"],related:["/docs/best_practices/cluster_setup_and_hardening/rbac_and_identity/kube2iam/","/docs/best_practices/cluster_setup_and_hardening/network_security/cloud_metadata_mitigation/","/docs/attack_vectors/cloud_metadata_service_abuse/"]},c="kiam",o={},l=[{value:"Architecture",id:"architecture",level:2},{value:"Agent (runs on all worker nodes)",id:"agent-runs-on-all-worker-nodes",level:3},{value:"Server (runs on master or dedicated nodes)",id:"server-runs-on-master-or-dedicated-nodes",level:3},{value:"Prerequisites",id:"prerequisites",level:2},{value:"Installation",id:"installation",level:2},{value:"Generate TLS Certificates",id:"generate-tls-certificates",level:3},{value:"Create TLS Secrets",id:"create-tls-secrets",level:3},{value:"Deploy Server",id:"deploy-server",level:3},{value:"Deploy Agent",id:"deploy-agent",level:3},{value:"AWS IAM Configuration",id:"aws-iam-configuration",level:2},{value:"Server Role",id:"server-role",level:3},{value:"Pod Roles Trust Policy",id:"pod-roles-trust-policy",level:3},{value:"Usage",id:"usage",level:2},{value:"Annotate Pods",id:"annotate-pods",level:3},{value:"Namespace Role Restrictions",id:"namespace-role-restrictions",level:3},{value:"Security Advantages Over kube2iam",id:"security-advantages-over-kube2iam",level:2},{value:"Migration to IRSA",id:"migration-to-irsa",level:2},{value:"References",id:"references",level:2}];function d(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,a.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"kiam",children:"kiam"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"kiam"})," provides AWS IAM credentials to Kubernetes pods using a client-server architecture. Unlike kube2iam, kiam separates the credential-serving component (server) from the metadata interception component (agent), improving security by reducing the attack surface on worker nodes."]}),"\n",(0,s.jsx)(n.p,{children:"The server component runs on master/dedicated nodes and handles IAM role assumption, while agents on worker nodes only intercept metadata requests."}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"architecture",children:"Architecture"}),"\n",(0,s.jsx)(n.p,{children:"kiam consists of two components:"}),"\n",(0,s.jsx)(n.h3,{id:"agent-runs-on-all-worker-nodes",children:"Agent (runs on all worker nodes)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Intercepts requests to the EC2 metadata service (169.254.169.254)."}),"\n",(0,s.jsx)(n.li,{children:"Forwards credential requests to the server."}),"\n",(0,s.jsx)(n.li,{children:"Does not assume IAM roles directly."}),"\n",(0,s.jsx)(n.li,{children:"Runs as a DaemonSet with minimal privileges."}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"server-runs-on-master-or-dedicated-nodes",children:"Server (runs on master or dedicated nodes)"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Assumes IAM roles on behalf of pods."}),"\n",(0,s.jsx)(n.li,{children:"Returns temporary credentials to agents."}),"\n",(0,s.jsx)(n.li,{children:"Requires IAM permissions to assume roles."}),"\n",(0,s.jsx)(n.li,{children:"Should run on nodes with restricted access."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"prerequisites",children:"Prerequisites"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"AWS IAM roles configured with appropriate trust policies."}),"\n",(0,s.jsx)(n.li,{children:"TLS certificates for secure agent-server communication."}),"\n",(0,s.jsx)(n.li,{children:"Network policies to restrict server access."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"installation",children:"Installation"}),"\n",(0,s.jsx)(n.h3,{id:"generate-tls-certificates",children:"Generate TLS Certificates"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:'# Create CA\nopenssl genrsa -out ca.key 2048\nopenssl req -x509 -new -nodes -key ca.key -days 365 -out ca.crt -subj "/CN=kiam-ca"\n\n# Create server certificate\nopenssl genrsa -out server.key 2048\nopenssl req -new -key server.key -out server.csr -subj "/CN=kiam-server"\nopenssl x509 -req -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out server.crt -days 365\n\n# Create agent certificate\nopenssl genrsa -out agent.key 2048\nopenssl req -new -key agent.key -out agent.csr -subj "/CN=kiam-agent"\nopenssl x509 -req -in agent.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out agent.crt -days 365\n'})}),"\n",(0,s.jsx)(n.h3,{id:"create-tls-secrets",children:"Create TLS Secrets"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-bash",children:"kubectl create secret generic kiam-server-tls -n kube-system \\\n  --from-file=ca.crt --from-file=server.crt --from-file=server.key\n\nkubectl create secret generic kiam-agent-tls -n kube-system \\\n  --from-file=ca.crt --from-file=agent.crt --from-file=agent.key\n"})}),"\n",(0,s.jsx)(n.h3,{id:"deploy-server",children:"Deploy Server"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: kiam-server\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      app: kiam-server\n  template:\n    metadata:\n      labels:\n        app: kiam-server\n    spec:\n      nodeSelector:\n        node-role.kubernetes.io/master: ""\n      tolerations:\n        - key: node-role.kubernetes.io/master\n          effect: NoSchedule\n      hostNetwork: true\n      serviceAccountName: kiam-server\n      containers:\n        - name: kiam-server\n          image: quay.io/uswitch/kiam:latest\n          args:\n            - server\n            - --json-log\n            - --level=info\n            - --bind=0.0.0.0:443\n            - --cert=/etc/kiam/tls/server.crt\n            - --key=/etc/kiam/tls/server.key\n            - --ca=/etc/kiam/tls/ca.crt\n            - --role-base-arn-autodetect\n            - --assume-role-arn=arn:aws:iam::123456789012:role/kiam-server\n            - --session-duration=15m\n          volumeMounts:\n            - name: tls\n              mountPath: /etc/kiam/tls\n      volumes:\n        - name: tls\n          secret:\n            secretName: kiam-server-tls\n'})}),"\n",(0,s.jsx)(n.h3,{id:"deploy-agent",children:"Deploy Agent"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: apps/v1\nkind: DaemonSet\nmetadata:\n  name: kiam-agent\n  namespace: kube-system\nspec:\n  selector:\n    matchLabels:\n      app: kiam-agent\n  template:\n    metadata:\n      labels:\n        app: kiam-agent\n    spec:\n      hostNetwork: true\n      serviceAccountName: kiam-agent\n      containers:\n        - name: kiam-agent\n          image: quay.io/uswitch/kiam:latest\n          args:\n            - agent\n            - --iptables\n            - --host-interface=eni+\n            - --json-log\n            - --level=info\n            - --port=8181\n            - --cert=/etc/kiam/tls/agent.crt\n            - --key=/etc/kiam/tls/agent.key\n            - --ca=/etc/kiam/tls/ca.crt\n            - --server-address=kiam-server:443\n            - --gateway-timeout-creation=1s\n          volumeMounts:\n            - name: tls\n              mountPath: /etc/kiam/tls\n          securityContext:\n            privileged: true\n      volumes:\n        - name: tls\n          secret:\n            secretName: kiam-agent-tls\n"})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"aws-iam-configuration",children:"AWS IAM Configuration"}),"\n",(0,s.jsx)(n.h3,{id:"server-role",children:"Server Role"}),"\n",(0,s.jsx)(n.p,{children:"The kiam server role needs permission to assume other roles:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": "sts:AssumeRole",\n      "Resource": "arn:aws:iam::123456789012:role/k8s-*"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"pod-roles-trust-policy",children:"Pod Roles Trust Policy"}),"\n",(0,s.jsx)(n.p,{children:"Pod roles must trust the kiam server role:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": {\n        "AWS": "arn:aws:iam::123456789012:role/kiam-server"\n      },\n      "Action": "sts:AssumeRole"\n    }\n  ]\n}\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"usage",children:"Usage"}),"\n",(0,s.jsx)(n.h3,{id:"annotate-pods",children:"Annotate Pods"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:"apiVersion: v1\nkind: Pod\nmetadata:\n  name: my-app\n  annotations:\n    iam.amazonaws.com/role: k8s-my-app-role\nspec:\n  containers:\n    - name: my-app\n      image: my-app:latest\n"})}),"\n",(0,s.jsx)(n.h3,{id:"namespace-role-restrictions",children:"Namespace Role Restrictions"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-yaml",children:'apiVersion: v1\nkind: Namespace\nmetadata:\n  name: production\n  annotations:\n    iam.amazonaws.com/permitted: "k8s-production-.*"\n'})}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"security-advantages-over-kube2iam",children:"Security Advantages Over kube2iam"}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Feature"}),(0,s.jsx)(n.th,{children:"kiam"}),(0,s.jsx)(n.th,{children:"kube2iam"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Role assumption location"}),(0,s.jsx)(n.td,{children:"Dedicated server"}),(0,s.jsx)(n.td,{children:"Every worker node"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"TLS encryption"}),(0,s.jsx)(n.td,{children:"Required"}),(0,s.jsx)(n.td,{children:"Optional"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Credential caching"}),(0,s.jsx)(n.td,{children:"Server-side"}),(0,s.jsx)(n.td,{children:"Per-node"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:"Blast radius"}),(0,s.jsx)(n.td,{children:"Server nodes only"}),(0,s.jsx)(n.td,{children:"All worker nodes"})]})]})]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"migration-to-irsa",children:"Migration to IRSA"}),"\n",(0,s.jsx)(n.p,{children:"AWS recommends migrating to IAM Roles for Service Accounts (IRSA):"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Better security model using OIDC federation."}),"\n",(0,s.jsx)(n.li,{children:"No iptables or privileged containers required."}),"\n",(0,s.jsx)(n.li,{children:"Native EKS integration."}),"\n",(0,s.jsx)(n.li,{children:"Auditable credential binding."}),"\n"]}),"\n",(0,s.jsx)(n.hr,{}),"\n",(0,s.jsx)(n.h2,{id:"references",children:"References"}),"\n",(0,s.jsx)(n.p,{children:"This article is based on information from the following official sources:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/uswitch/kiam",children:"kiam GitHub Repository"})," - GitHub"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://docs.aws.amazon.com/eks/latest/userguide/iam-roles-for-service-accounts.html",children:"IAM Roles for Service Accounts"})," - AWS Documentation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"https://github.com/uswitch/kiam/blob/master/docs/ARCHITECTURE.md",children:"kiam Architecture"})," - kiam Documentation"]}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,a.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>i,x:()=>c});var r=t(6540);const s={},a=r.createContext(s);function i(e){const n=r.useContext(a);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:i(e.components),r.createElement(a.Provider,{value:n},e.children)}}}]);